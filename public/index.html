<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Al√©rgenos - Con Trazas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #f8fafc; min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .gradient-header { background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%); }
        .btn-primary { background: linear-gradient(135deg, #D4AF37 0%, #B8860B 100%); transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .allergen-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #fef2f2; border: 2px solid #fecaca; border-radius: 8px; margin: 0.25rem; font-size: 0.875rem; }
        .trace-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: #fefce8; border: 2px solid #fde047; border-radius: 8px; margin: 0.25rem; font-size: 0.875rem; }
        .tab-active { border-bottom: 3px solid #D4AF37; color: #D4AF37; font-weight: bold; }
        .ingredient-item { cursor: pointer; transition: all 0.2s; }
        .ingredient-item:hover { background: #f0f9ff; transform: translateX(5px); }
        .ingredient-selected { background: #dbeafe !important; border-left: 4px solid #3b82f6; }
        .trace-checkbox { width: 20px; height: 20px; cursor: pointer; }
    </style>
</head>
<body>
    
    <!-- Header -->
    <div class="gradient-header text-white py-6 mb-6 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üçΩÔ∏è</span>
                    <div>
                        <h1 class="text-2xl font-bold">Sistema de Al√©rgenos PRO</h1>
                        <p class="text-sm opacity-90">Con Trazas y Traducci√≥n Multiidioma</p>
                    </div>
                </div>
                <div id="dbStatus" class="text-sm bg-white/20 px-4 py-2 rounded-lg">
                    <span class="spinner w-4 h-4 border-2 border-white border-t-transparent rounded-full inline-block mr-2"></span>
                    Conectando...
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="max-w-7xl mx-auto px-4 mb-6">
        <div class="bg-white rounded-lg shadow-sm p-2 flex gap-2">
            <button onclick="showTab('new-dish')" id="tab-new-dish" class="tab-active flex-1 py-3 px-4 rounded-lg transition-all">
                ‚ûï Nuevo Plato
            </button>
            <button onclick="showTab('saved-dishes')" id="tab-saved-dishes" class="flex-1 py-3 px-4 rounded-lg transition-all hover:bg-gray-100">
                üìö Platos Guardados
            </button>
            <button onclick="showTab('ingredients')" id="tab-ingredients" class="flex-1 py-3 px-4 rounded-lg transition-all hover:bg-gray-100">
                ü•ò Ingredientes
            </button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 pb-8">
        
        <!-- TAB: NUEVO PLATO -->
        <div id="content-new-dish" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                <!-- Panel Principal -->
                <div class="lg:col-span-2 space-y-6">
                    
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">üìù Crear Nuevo Plato</h2>

                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ü•ò Nombre del Plato</label>
                                <input 
                                    type="text"
                                    id="dishName"
                                    placeholder="Ej: Paella Valenciana"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none"
                                >
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üîç Buscar y A√±adir Ingredientes</label>
                                <input 
                                    type="text"
                                    id="ingredientSearch"
                                    placeholder="Buscar ingrediente..."
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none"
                                    oninput="searchIngredients()"
                                >
                                <div id="ingredientResults" class="mt-2 max-h-60 overflow-y-auto"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‚úÖ Ingredientes Seleccionados</label>
                                <div id="selectedIngredients" class="min-h-20 p-4 border-2 border-dashed border-gray-300 rounded-lg">
                                    <p class="text-gray-400 text-sm text-center">Busca y a√±ade ingredientes arriba</p>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üìù Proceso de Elaboraci√≥n</label>
                                <textarea 
                                    id="elaboration"
                                    rows="4"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none resize-none"
                                    placeholder="1. Sofre√≠r el ajo y la cebolla...&#10;2. A√±adir el arroz...&#10;3. Incorporar el caldo..."
                                ></textarea>
                            </div>

                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4">
                                <label class="block text-sm font-bold text-yellow-800 mb-3">
                                    ‚ö° Trazas (Contaminaci√≥n Cruzada)
                                </label>
                                <p class="text-xs text-yellow-700 mb-3">
                                    Selecciona los al√©rgenos que PUEDEN estar presentes por elaboraci√≥n en cocina compartida
                                </p>
                                <div class="grid grid-cols-2 gap-2" id="tracesCheckboxes">
                                    <!-- Se generar√° din√°micamente con JavaScript -->
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üë®‚Äçüç≥ Chef Responsable</label>
                                <input 
                                    type="text"
                                    id="chef"
                                    value="Chef Principal"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none"
                                >
                            </div>

                            <button 
                                onclick="createDish()"
                                class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg shadow">
                                üíæ Guardar Plato
                            </button>
                        </div>

                        <div id="loading" class="hidden mt-4 flex items-center justify-center gap-3 p-4 bg-blue-50 rounded-lg">
                            <div class="spinner w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                            <span class="text-blue-700 font-medium text-sm">Guardando y traduciendo...</span>
                        </div>
                    </div>

                    <!-- Resultados -->
                    <div id="results" class="hidden space-y-6">
                        
                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-lg p-4">
                                <h3 class="text-lg font-bold text-green-800 mb-2">‚úÖ Plato Guardado</h3>
                                <div id="resultDishName" class="text-2xl font-bold text-gray-800 mb-1"></div>
                                <div id="resultMeta" class="text-sm text-gray-600"></div>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">‚ö†Ô∏è Al√©rgenos Detectados</h4>
                            <div id="resultAllergens"></div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm p-6" id="resultTracesSection" style="display:none;">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">‚ö° Trazas (Puede Contener)</h4>
                            <div id="resultTraces"></div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm p-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">üìÑ Generar Documentos</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button 
                                    onclick="generateLabelFromResult()"
                                    class="p-4 border-2 border-gray-200 rounded-lg hover:border-yellow-500 transition-all">
                                    <div class="text-3xl mb-2">üè∑Ô∏è</div>
                                    <h5 class="font-bold text-gray-800">Etiqueta Multiidioma</h5>
                                    <p class="text-xs text-gray-500 mt-1">Con al√©rgenos y trazas</p>
                                </button>
                                <button 
                                    onclick="generateRecipeFromResult()"
                                    class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 transition-all">
                                    <div class="text-3xl mb-2">üìã</div>
                                    <h5 class="font-bold text-gray-800">Recetario Oficial</h5>
                                    <p class="text-xs text-gray-500 mt-1">Control sanitario</p>
                                </button>
                            </div>
                        </div>

                        <button 
                            onclick="resetForm()"
                            class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow transition-all">
                            üîÑ Crear Otro Plato
                        </button>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="space-y-6">
                    <div class="bg-white rounded-2xl shadow-sm p-5">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">üìã Platos de Hoy</h3>
                        <div id="todayDishes" class="space-y-2">
                            <div class="text-center py-8 text-gray-400">
                                <div class="text-4xl mb-2">üçΩÔ∏è</div>
                                <p class="text-sm">Cargando...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: PLATOS GUARDADOS -->
        <div id="content-saved-dishes" class="tab-content hidden">
            <div class="bg-white rounded-2xl shadow-sm p-6 mb-6">
                <div class="flex gap-4 items-center">
                    <input 
                        type="text"
                        id="dishSearchInput"
                        placeholder="üîç Buscar plato guardado..."
                        class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none"
                        oninput="searchDishes()"
                    >
                    <button onclick="loadAllDishes()" class="btn-primary text-white px-6 py-3 rounded-lg font-bold">
                        üîÑ Recargar
                    </button>
                </div>
            </div>

            <div id="savedDishesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="col-span-full text-center py-12 text-gray-400">
                    <div class="text-5xl mb-3">üìö</div>
                    <p>Cargando platos guardados...</p>
                </div>
            </div>
        </div>

        <!-- TAB: INGREDIENTES -->
        <div id="content-ingredients" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Lista de Ingredientes -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üì¶ Base de Ingredientes</h3>
                    <input 
                        type="text"
                        id="ingredientFilterInput"
                        placeholder="üîç Filtrar ingredientes..."
                        class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none mb-4"
                        oninput="filterIngredients()"
                    >
                    <div id="ingredientsList" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-gray-400 text-center py-8">Cargando ingredientes...</p>
                    </div>
                </div>

                <!-- A√±adir Ingrediente -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">‚ûï A√±adir Ingrediente</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre</label>
                            <input type="text" id="newIngName" placeholder="Ej: Tomate" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Categor√≠a</label>
                            <select id="newIngCategory" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none">
                                <option value="verduras">Verduras</option>
                                <option value="carnes">Carnes</option>
                                <option value="pescados">Pescados</option>
                                <option value="mariscos">Mariscos</option>
                                <option value="lacteos">L√°cteos</option>
                                <option value="cereales">Cereales</option>
                                <option value="frutos_secos">Frutos Secos</option>
                                <option value="salsas">Salsas</option>
                                <option value="condimentos">Condimentos</option>
                                <option value="otros">Otros</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Al√©rgenos (contiene directamente)</label>
                            <select id="newIngAllergens" multiple class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none" size="6">
                                <option value="gluten">üåæ Gluten</option>
                                <option value="crustaceos">ü¶ê Crust√°ceos</option>
                                <option value="huevos">ü•ö Huevos</option>
                                <option value="pescado">üêü Pescado</option>
                                <option value="cacahuetes">ü•ú Cacahuetes</option>
                                <option value="soja">üå± Soja</option>
                                <option value="lacteos">ü•õ L√°cteos</option>
                                <option value="frutos_secos">üå∞ Frutos Secos</option>
                                <option value="apio">ü•¨ Apio</option>
                                <option value="mostaza">üü° Mostaza</option>
                                <option value="sesamo">ü´ò S√©samo</option>
                                <option value="sulfitos">üç∑ Sulfitos</option>
                                <option value="moluscos">üêö Moluscos</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Mant√©n Ctrl/Cmd para seleccionar varios</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Trazas (puede contener)</label>
                            <select id="newIngTraces" multiple class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none" size="6">
                                <option value="gluten">üåæ Gluten</option>
                                <option value="crustaceos">ü¶ê Crust√°ceos</option>
                                <option value="huevos">ü•ö Huevos</option>
                                <option value="pescado">üêü Pescado</option>
                                <option value="cacahuetes">ü•ú Cacahuetes</option>
                                <option value="soja">üå± Soja</option>
                                <option value="lacteos">ü•õ L√°cteos</option>
                                <option value="frutos_secos">üå∞ Frutos Secos</option>
                                <option value="apio">ü•¨ Apio</option>
                                <option value="mostaza">üü° Mostaza</option>
                                <option value="sesamo">ü´ò S√©samo</option>
                                <option value="sulfitos">üç∑ Sulfitos</option>
                                <option value="moluscos">üêö Moluscos</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1">Por contaminaci√≥n cruzada</p>
                        </div>
                        <button onclick="addNewIngredient()" class="btn-primary w-full text-white font-bold py-3 px-4 rounded-lg shadow">
                            ‚ûï A√±adir Ingrediente
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const ALLERGENS = {
            'gluten': { name: 'Cereales con Gluten', icon: 'üåæ' },
            'crustaceos': { name: 'Crust√°ceos', icon: 'ü¶ê' },
            'huevos': { name: 'Huevos', icon: 'ü•ö' },
            'pescado': { name: 'Pescado', icon: 'üêü' },
            'cacahuetes': { name: 'Cacahuetes', icon: 'ü•ú' },
            'soja': { name: 'Soja', icon: 'üå±' },
            'lacteos': { name: 'L√°cteos', icon: 'ü•õ' },
            'frutos_secos': { name: 'Frutos Secos', icon: 'üå∞' },
            'apio': { name: 'Apio', icon: 'ü•¨' },
            'mostaza': { name: 'Mostaza', icon: 'üü°' },
            'sesamo': { name: 'S√©samo', icon: 'ü´ò' },
            'sulfitos': { name: 'Sulfitos', icon: 'üç∑' },
            'altramuces': { name: 'Altramuces', icon: 'ü´ò' },
            'moluscos': { name: 'Moluscos', icon: 'üêö' }
        };

        let selectedIngredients = [];
        let currentDish = null;
        let allIngredients = [];
        let searchTimeout = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            await checkSystemStatus();
            await loadAllIngredients();
            await loadTodayDishes();
            generateTracesCheckboxes();
        });

        // Generar checkboxes de trazas
        function generateTracesCheckboxes() {
            const container = document.getElementById('tracesCheckboxes');
            container.innerHTML = Object.entries(ALLERGENS).map(([code, data]) => `
                <label class="flex items-center gap-2 p-2 hover:bg-yellow-100 rounded cursor-pointer">
                    <input type="checkbox" name="trace" value="${code}" class="trace-checkbox">
                    <span class="text-sm">${data.icon} ${data.name}</span>
                </label>
            `).join('');
        }

        // Obtener trazas seleccionadas
        function getSelectedTraces() {
            const checkboxes = document.querySelectorAll('input[name="trace"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Sistema
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/system-status');
                const data = await response.json();
                const statusEl = document.getElementById('dbStatus');
                
                if (data.success && data.database === 'connected') {
                    statusEl.innerHTML = '‚úÖ Sistema Activo';
                    statusEl.className = 'text-sm bg-green-500/90 px-4 py-2 rounded-lg';
                } else {
                    statusEl.innerHTML = '‚ùå Sistema Desconectado';
                    statusEl.className = 'text-sm bg-red-500/90 px-4 py-2 rounded-lg';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('dbStatus').innerHTML = '‚ö†Ô∏è Error';
            }
        }

        // Tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.remove('tab-active'));
            
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');

            if (tabName === 'saved-dishes') loadAllDishes();
            if (tabName === 'ingredients') {
                loadAllIngredients();
                filterIngredients();
            }
        }

        // Ingredientes
        async function loadAllIngredients() {
            try {
                const response = await fetch('/api/ingredients');
                const data = await response.json();
                allIngredients = data.ingredients || [];
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function searchIngredients() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const query = document.getElementById('ingredientSearch').value.trim();
                if (query.length < 2) {
                    document.getElementById('ingredientResults').innerHTML = '';
                    return;
                }

                try {
                    const response = await fetch(`/api/ingredients/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    displayIngredientResults(data.ingredients || []);
                } catch (error) {
                    console.error('Error:', error);
                }
            }, 300);
        }

        function displayIngredientResults(ingredients) {
            const container = document.getElementById('ingredientResults');
            
            if (ingredients.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm p-2">No se encontraron ingredientes</p>';
                return;
            }

            container.innerHTML = ingredients.map(ing => `
                <div onclick="addIngredient(${ing.id}, '${ing.name.replace(/'/g, "\\'")}')" 
                     class="ingredient-item p-3 border rounded-lg hover:bg-blue-50 cursor-pointer flex justify-between items-center">
                    <span class="font-medium">${ing.name}</span>
                    <span class="text-xs text-gray-500">${ing.category}</span>
                </div>
            `).join('');
        }

        function addIngredient(id, name) {
            if (selectedIngredients.find(i => i.id === id)) {
                showToast('‚ö†Ô∏è Ya a√±adido', 'warning');
                return;
            }

            const ingredient = allIngredients.find(i => i.id === id);
            selectedIngredients.push({ id, name, quantity: '', allergens: ingredient?.allergens || [] });
            
            document.getElementById('ingredientSearch').value = '';
            document.getElementById('ingredientResults').innerHTML = '';
            updateSelectedIngredients();
        }

        function removeIngredient(id) {
            selectedIngredients = selectedIngredients.filter(i => i.id !== id);
            updateSelectedIngredients();
        }

        function updateSelectedIngredients() {
            const container = document.getElementById('selectedIngredients');
            
            if (selectedIngredients.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center">Busca y a√±ade ingredientes arriba</p>';
                return;
            }

            container.innerHTML = selectedIngredients.map(ing => `
                <div class="flex items-center justify-between p-2 bg-blue-50 rounded-lg mb-2">
                    <span class="font-medium">${ing.name}</span>
                    <button onclick="removeIngredient(${ing.id})" class="text-red-500 hover:text-red-700 font-bold">‚úï</button>
                </div>
            `).join('');
        }

        // Crear plato
        async function createDish() {
            const name = document.getElementById('dishName').value.trim();
            const elaboration = document.getElementById('elaboration').value.trim();
            const chef = document.getElementById('chef').value.trim();
            const manualTraces = getSelectedTraces();

            if (!name) {
                showToast('‚ö†Ô∏è Escribe el nombre del plato', 'warning');
                return;
            }

            if (selectedIngredients.length === 0) {
                showToast('‚ö†Ô∏è A√±ade al menos un ingrediente', 'warning');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');

            try {
                const response = await fetch('/api/dishes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        description: name,
                        elaboration,
                        chef,
                        ingredients: selectedIngredients,
                        manualTraces: manualTraces
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentDish = data.dish;
                    displayResults(data.dish);
                    loadTodayDishes();
                    showToast('‚úÖ Plato guardado correctamente', 'success');
                } else {
                    showToast('‚ùå Error: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error de conexi√≥n', 'error');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function displayResults(dish) {
            document.getElementById('resultDishName').textContent = dish.name;
            document.getElementById('resultMeta').innerHTML = `<strong>Chef:</strong> ${dish.chef} | <strong>ID:</strong> #${dish.id}`;
            
            const allergensEl = document.getElementById('resultAllergens');
            
            if (!dish.allergens || dish.allergens.length === 0) {
                allergensEl.innerHTML = `
                    <div class="bg-green-50 border-2 border-green-400 rounded-lg p-6 text-center">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <div class="text-green-800 font-bold text-lg">Sin Al√©rgenos</div>
                    </div>
                `;
            } else {
                allergensEl.innerHTML = dish.allergens.map(code => {
                    const a = ALLERGENS[code];
                    return a ? `
                        <div class="allergen-badge">
                            <span class="text-xl">${a.icon}</span>
                            <span class="font-bold">${a.name}</span>
                        </div>
                    ` : '';
                }).join('');
            }

            // Mostrar trazas si existen
            const tracesSection = document.getElementById('resultTracesSection');
            const tracesEl = document.getElementById('resultTraces');
            
            if (dish.traces && dish.traces.length > 0) {
                tracesSection.style.display = 'block';
                tracesEl.innerHTML = dish.traces.map(code => {
                    const a = ALLERGENS[code];
                    return a ? `
                        <div class="trace-badge">
                            <span class="text-xl">${a.icon}</span>
                            <span class="font-bold">${a.name}</span>
                        </div>
                    ` : '';
                }).join('');
            } else {
                tracesSection.style.display = 'none';
            }
            
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('dishName').value = '';
            document.getElementById('elaboration').value = '';
            selectedIngredients = [];
            updateSelectedIngredients();
            document.querySelectorAll('input[name="trace"]').forEach(cb => cb.checked = false);
            document.getElementById('results').classList.add('hidden');
            currentDish = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Documentos
        async function generateLabelFromResult() {
            if (!currentDish) return;
            await generateDocument(currentDish.id, 'label');
        }

        async function generateRecipeFromResult() {
            if (!currentDish) return;
            await generateDocument(currentDish.id, 'recipe');
        }

        async function generateDocument(dishId, type) {
            try {
                const endpoint = type === 'label' ? '/api/generate-label' : '/api/generate-recipe-document';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dishId })
                });

                if (response.ok) {
                    const html = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                    showToast('‚ú® Documento generado', 'success');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error generando documento', 'error');
            }
        }

        // Platos guardados
        async function loadAllDishes() {
            try {
                const response = await fetch('/api/dishes');
                const data = await response.json();
                displaySavedDishes(data.dishes || []);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function searchDishes() {
            const query = document.getElementById('dishSearchInput').value.trim();
            if (query.length < 2) {
                loadAllDishes();
                return;
            }

            try {
                const response = await fetch(`/api/dishes/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                displaySavedDishes(data.dishes || []);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function displaySavedDishes(dishes) {
            const container = document.getElementById('savedDishesList');
            
            if (dishes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 text-gray-400">
                        <div class="text-5xl mb-3">üìö</div>
                        <p>No hay platos guardados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = dishes.map(dish => `
                <div class="bg-white rounded-xl shadow-sm p-5 hover:shadow-md transition-all">
                    <h3 class="font-bold text-lg mb-2">${dish.name}</h3>
                    <p class="text-sm text-gray-600 mb-3">
                        <strong>Chef:</strong> ${dish.chef}<br>
                        <strong>Fecha:</strong> ${new Date(dish.date).toLocaleDateString('es-ES')}
                    </p>
                    
                    ${dish.allergens && dish.allergens.length > 0 ? `
                        <div class="mb-2">
                            <span class="text-xs font-semibold text-red-700">‚ö†Ô∏è ${dish.allergens.length} al√©rgeno${dish.allergens.length > 1 ? 's' : ''}</span>
                        </div>
                    ` : `
                        <div class="mb-2">
                            <span class="text-xs font-semibold text-green-700">‚úÖ Sin al√©rgenos</span>
                        </div>
                    `}

                    ${dish.traces && dish.traces.length > 0 ? `
                        <div class="mb-3">
                            <span class="text-xs font-semibold text-yellow-700">‚ö° ${dish.traces.length} traza${dish.traces.length > 1 ? 's' : ''}</span>
                        </div>
                    ` : ''}
                    
                    <div class="flex gap-2">
                        <button onclick="generateDocument(${dish.id}, 'label')" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-bold py-2 px-3 rounded">
                            üè∑Ô∏è Etiqueta
                        </button>
                        <button onclick="generateDocument(${dish.id}, 'recipe')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 px-3 rounded">
                            üìã Receta
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Platos de hoy
        async function loadTodayDishes() {
            try {
                const response = await fetch('/api/dishes/today');
                const data = await response.json();
                
                const container = document.getElementById('todayDishes');
                
                if (!data.dishes || data.dishes.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üçΩÔ∏è</div>
                            <p class="text-sm">Sin platos hoy</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = data.dishes.map(dish => `
                    <div class="p-3 bg-gray-50 rounded-lg border-l-4 border-yellow-500">
                        <div class="font-bold text-gray-800 text-sm mb-1">${dish.name}</div>
                        <div class="text-xs text-gray-500 mb-2">üë®‚Äçüç≥ ${dish.chef}</div>
                        ${dish.allergens && dish.allergens.length > 0 ? `
                            <div class="text-xs mb-1">
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full font-medium">
                                    ‚ö†Ô∏è ${dish.allergens.length}
                                </span>
                            </div>
                        ` : ''}
                        ${dish.traces && dish.traces.length > 0 ? `
                            <div class="text-xs">
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium">
                                    ‚ö° ${dish.traces.length}
                                </span>
                            </div>
                        ` : ''}
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Gesti√≥n de ingredientes
        function filterIngredients() {
            const query = document.getElementById('ingredientFilterInput').value.toLowerCase();
            const filtered = allIngredients.filter(ing => 
                ing.name.toLowerCase().includes(query) || 
                ing.category.toLowerCase().includes(query)
            );
            
            const container = document.getElementById('ingredientsList');
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">No se encontraron ingredientes</p>';
                return;
            }

            const grouped = filtered.reduce((acc, ing) => {
                if (!acc[ing.category]) acc[ing.category] = [];
                acc[ing.category].push(ing);
                return acc;
            }, {});

            container.innerHTML = Object.entries(grouped).map(([category, ings]) => `
                <div class="mb-4">
                    <h4 class="font-bold text-sm text-gray-600 mb-2 uppercase">${category}</h4>
                    ${ings.map(ing => `
                        <div class="p-2 border-b hover:bg-gray-50">
                            <div class="font-medium text-sm">${ing.name}</div>
                            ${ing.allergens && ing.allergens.length > 0 ? `
                                <div class="text-xs text-red-600 mt-1">
                                    ‚ö†Ô∏è ${ing.allergens.map(a => ALLERGENS[a]?.icon || '‚ö†Ô∏è').join(' ')}
                                </div>
                            ` : ''}
                            ${ing.traces && ing.traces.length > 0 ? `
                                <div class="text-xs text-yellow-600 mt-1">
                                    ‚ö° ${ing.traces.map(a => ALLERGENS[a]?.icon || '‚ö°').join(' ')}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        async function addNewIngredient() {
            const name = document.getElementById('newIngName').value.trim();
            const category = document.getElementById('newIngCategory').value;
            const allergensSelect = document.getElementById('newIngAllergens');
            const tracesSelect = document.getElementById('newIngTraces');
            const allergens = Array.from(allergensSelect.selectedOptions).map(opt => opt.value);
            const traces = Array.from(tracesSelect.selectedOptions).map(opt => opt.value);

            if (!name) {
                showToast('‚ö†Ô∏è Escribe el nombre del ingrediente', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/ingredients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        category,
                        allergens,
                        traces
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('‚úÖ Ingrediente a√±adido', 'success');
                    document.getElementById('newIngName').value = '';
                    allergensSelect.selectedIndex = -1;
                    tracesSelect.selectedIndex = -1;
                    await loadAllIngredients();
                    filterIngredients();
                } else {
                    showToast('‚ùå Error: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Toast
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-5 py-3 rounded-lg shadow-lg z-50 text-sm font-medium`;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>

</body>
</html>
