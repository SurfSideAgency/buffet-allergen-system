<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Al√©rgenos - Buffet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-primary: #D4AF37;
            --color-primary-dark: #B8860B;
        }
        body { background: #f8fafc; min-height: 100vh; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .gradient-header { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); }
        .analyze-btn { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%); transition: all 0.2s; }
        .analyze-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3); }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .voice-btn { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .voice-btn.recording { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } }
        .allergen-badge { display: inline-flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: #fef2f2; border: 2px solid #fecaca; border-radius: 12px; margin: 0.25rem; }
        .allergen-badge:hover { border-color: #ef4444; background: #fee2e2; }
    </style>
</head>
<body>
    
    <!-- Header -->
    <div class="gradient-header text-white py-6 mb-6 shadow-sm">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üçΩÔ∏è</span>
                    <div>
                        <h1 class="text-2xl font-bold">Sistema de Al√©rgenos</h1>
                        <p class="text-sm opacity-90">Control Sanitario de Buffet</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="max-w-7xl mx-auto px-4 pb-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Panel Principal -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Formulario -->
                <div class="bg-white rounded-2xl shadow-sm p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">üìù Describe el Plato</h2>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ü•ò Plato e Ingredientes</label>
                            <textarea 
                                id="dishInput"
                                rows="3"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none resize-none"
                                placeholder="Ejemplo: Paella valenciana con arroz, gambas, mejillones, pollo y azafr√°n"
                            ></textarea>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">üìù Proceso de Elaboraci√≥n <span class="text-xs text-gray-500">(para recetario)</span></label>
                            <textarea 
                                id="elaborationInput"
                                rows="4"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none resize-none"
                                placeholder="1. Sofre√≠r el ajo y la cebolla...&#10;2. A√±adir el arroz...&#10;3. Incorporar el caldo..."
                            ></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">üë®‚Äçüç≥ Chef Responsable</label>
                                <input 
                                    type="text"
                                    id="chefInput"
                                    value="Chef Principal"
                                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:outline-none"
                                >
                            </div>
                            <div class="flex items-end">
                                <button 
                                    onclick="analyzeDish()"
                                    class="analyze-btn w-full text-white font-bold py-2 px-4 rounded-lg shadow">
                                    üîç Analizar
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="loading" class="hidden mt-4 flex items-center justify-center gap-3 p-4 bg-blue-50 rounded-lg">
                        <div class="spinner w-5 h-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                        <span class="text-blue-700 font-medium text-sm">Analizando...</span>
                    </div>
                </div>

                <!-- Resultados -->
                <div id="results" class="hidden space-y-6">
                    
                    <!-- Plato Creado -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-400 rounded-lg p-4">
                            <h3 class="text-lg font-bold text-green-800 mb-2">‚úÖ An√°lisis Completado</h3>
                            <div id="dishName" class="text-2xl font-bold text-gray-800 mb-1"></div>
                            <div id="dishMeta" class="text-sm text-gray-600"></div>
                        </div>
                    </div>

                    <!-- Al√©rgenos -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">‚ö†Ô∏è Al√©rgenos Detectados</h4>
                        <div id="allergensList"></div>
                    </div>

                    <!-- Documentos -->
                    <div class="bg-white rounded-2xl shadow-sm p-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">üìÑ Generar Documentos</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button 
                                onclick="generateLabel()"
                                class="p-4 border-2 border-gray-200 rounded-lg hover:border-yellow-500 transition-all">
                                <div class="text-3xl mb-2">üè∑Ô∏è</div>
                                <h5 class="font-bold text-gray-800">Etiqueta para Buffet</h5>
                                <p class="text-xs text-gray-600 mt-1">Etiqueta simple con al√©rgenos</p>
                            </button>

                            <button 
                                onclick="generateRecipeDocument()"
                                class="p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 transition-all">
                                <div class="text-3xl mb-2">üìã</div>
                                <h5 class="font-bold text-gray-800">Recetario Oficial</h5>
                                <p class="text-xs text-gray-600 mt-1">Documento para Sanidad</p>
                            </button>
                        </div>
                    </div>

                    <button 
                        onclick="reset()"
                        class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg shadow transition-all">
                        üîÑ Nuevo An√°lisis
                    </button>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <div class="bg-white rounded-2xl shadow-sm p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-800">üìã Platos de Hoy</h3>
                        <span id="dishCount" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full font-semibold">0</span>
                    </div>
                    <div id="dishesList" class="space-y-2">
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üçΩÔ∏è</div>
                            <p class="text-sm">Sin platos registrados</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm p-5">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">‚ÑπÔ∏è Informaci√≥n</h3>
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex items-start gap-2"><span>‚ö†Ô∏è</span><p>14 al√©rgenos UE 1169/2011</p></div>
                        <div class="flex items-start gap-2"><span>üìÑ</span><p>Recetario para Sanidad</p></div>
                        <div class="flex items-start gap-2"><span>üè∑Ô∏è</span><p>Etiquetas para buffet</p></div>
                        <div class="flex items-start gap-2"><span>‚úÖ</span><p>Cumple normativa europea</p></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ALLERGENS_DATA = {
            'gluten': { name: 'Cereales con Gluten', icon: 'üåæ' },
            'crustaceos': { name: 'Crust√°ceos', icon: 'ü¶ê' },
            'huevos': { name: 'Huevos', icon: 'ü•ö' },
            'pescado': { name: 'Pescado', icon: 'üêü' },
            'cacahuetes': { name: 'Cacahuetes', icon: 'ü•ú' },
            'soja': { name: 'Soja', icon: 'üå±' },
            'lacteos': { name: 'L√°cteos', icon: 'ü•õ' },
            'frutos_secos': { name: 'Frutos Secos', icon: 'üå∞' },
            'apio': { name: 'Apio', icon: 'ü•¨' },
            'mostaza': { name: 'Mostaza', icon: 'üü°' },
            'sesamo': { name: 'S√©samo', icon: 'ü´ò' },
            'sulfitos': { name: 'Sulfitos', icon: 'üç∑' },
            'altramuces': { name: 'Altramuces', icon: 'ü´ò' },
            'moluscos': { name: 'Moluscos', icon: 'üêö' }
        };

        let currentDish = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadDishes();
        });

        async function analyzeDish() {
            const description = document.getElementById('dishInput').value.trim();
            const chef = document.getElementById('chefInput').value.trim();
            const elaboration = document.getElementById('elaborationInput').value.trim();

            if (!description) {
                showToast('‚ö†Ô∏è Por favor describe el plato', 'warning');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description, chef, elaboration })
                });

                const data = await response.json();

                if (data.success) {
                    currentDish = data.dish;
                    displayResults(data);
                    loadDishes();
                    showToast('‚úÖ An√°lisis completado', 'success');
                } else {
                    showToast('‚ùå Error: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error de conexi√≥n', 'error');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function displayResults(data) {
            document.getElementById('dishName').textContent = data.dish.name;
            document.getElementById('dishMeta').innerHTML = `<strong>Chef:</strong> ${data.dish.chef} | <strong>Fecha:</strong> ${data.dish.date}`;
            
            const allergensList = document.getElementById('allergensList');
            
            if (data.dish.allergens.length === 0) {
                allergensList.innerHTML = `
                    <div class="bg-green-50 border-2 border-green-400 rounded-lg p-6 text-center">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <div class="text-green-800 font-bold text-lg">Sin Al√©rgenos</div>
                        <p class="text-green-600 text-sm mt-1">Este plato no contiene al√©rgenos detectados</p>
                    </div>
                `;
            } else {
                allergensList.innerHTML = data.dish.allergens.map(code => {
                    const allergen = ALLERGENS_DATA[code];
                    if (!allergen) return '';
                    return `
                        <div class="allergen-badge">
                            <span class="text-2xl">${allergen.icon}</span>
                            <div class="flex-1">
                                <div class="font-bold text-sm">${allergen.name}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('results').classList.remove('hidden');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function generateLabel() {
            if (!currentDish) {
                showToast('‚ö†Ô∏è No hay plato para generar etiqueta', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/generate-label', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dishId: currentDish.id })
                });

                if (response.ok) {
                    const html = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                    showToast('‚ú® Etiqueta generada', 'success');
                } else {
                    showToast('‚ùå Error generando etiqueta', 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error de conexi√≥n', 'error');
            }
        }

        async function generateRecipeDocument() {
            if (!currentDish) {
                showToast('‚ö†Ô∏è No hay plato para generar recetario', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/generate-recipe-document', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dishId: currentDish.id })
                });

                if (response.ok) {
                    const html = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                    showToast('üìã Recetario generado', 'success');
                } else {
                    showToast('‚ùå Error generando recetario', 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error de conexi√≥n', 'error');
            }
        }

        function reset() {
            document.getElementById('dishInput').value = '';
            document.getElementById('elaborationInput').value = '';
            document.getElementById('results').classList.add('hidden');
            currentDish = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function loadDishes() {
            try {
                const response = await fetch('/api/dishes/today');
                const data = await response.json();

                const dishesList = document.getElementById('dishesList');
                const dishCount = document.getElementById('dishCount');

                dishCount.textContent = data.count || 0;

                if (!data.dishes || data.dishes.length === 0) {
                    dishesList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üçΩÔ∏è</div>
                            <p class="text-sm">Sin platos registrados</p>
                        </div>
                    `;
                    return;
                }

                dishesList.innerHTML = data.dishes.map(dish => `
                    <div class="p-3 bg-gray-50 rounded-lg border-l-4 border-yellow-500">
                        <div class="font-bold text-gray-800 text-sm mb-1">${dish.name}</div>
                        <div class="text-xs text-gray-500 mb-2">üë®‚Äçüç≥ ${dish.chef}</div>
                        ${dish.allergens.length > 0 ? `
                            <div class="text-xs">
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full font-medium">
                                    ‚ö†Ô∏è ${dish.allergens.length} al√©rgeno${dish.allergens.length > 1 ? 's' : ''}
                                </span>
                            </div>
                        ` : `
                            <div class="text-xs text-green-600 font-medium">‚úÖ Sin al√©rgenos</div>
                        `}
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error cargando platos:', error);
            }
        }

        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-5 py-3 rounded-lg shadow-lg z-50 text-sm font-medium`;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>

</body>
</html>
