<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Al√©rgenos - Chef + IA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --color-primary: #D4AF37;
            --color-primary-dark: #B8860B;
            --color-accent: #C44536;
            --color-success: #16A34A;
        }

        .analysis-mode-toggle {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f1f5f9;
            border-radius: 12px;
        }

        .toggle-option {
            flex: 1;
            text-align: center;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .toggle-option.active {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
        }

        .allergen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .allergen-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .allergen-card:hover {
            border-color: var(--color-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .allergen-card.selected {
            border-color: var(--color-accent);
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
        }

        .allergen-card.ai-detected {
            border-color: #3B82F6;
            background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
        }

        .allergen-card.ai-detected.selected {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        }

        .allergen-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        .allergen-name {
            font-weight: bold;
            color: #1f2937;
        }

        .ai-suggestion {
            background: #EFF6FF;
            border: 1px solid #DBEAFE;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .hybrid-panel {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .analysis-mode-toggle {
                flex-direction: column;
            }
            
            .allergen-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    
    <!-- Header -->
    <div class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 text-white rounded-full p-3 mr-4">
                        <span class="text-2xl">üçΩÔ∏è</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Sistema de Al√©rgenos</h1>
                        <p class="text-gray-600">An√°lisis H√≠brido: IA + Manual</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="flex items-center space-x-2 text-green-600">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-sm font-medium">Sistema Activo</span>
                        </div>
                        <div class="text-xs text-gray-500" id="currentDateTime"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Panel Principal -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <span class="mr-3">üéØ</span>
                        Registrar Nuevo Plato
                    </h2>

                    <!-- Selector de Modo de An√°lisis -->
                    <div class="analysis-mode-toggle">
                        <div class="toggle-option active" data-mode="hybrid" onclick="setAnalysisMode('hybrid')">
                            <div class="text-lg mb-1">ü§ñ‚ûïüë®‚Äçüç≥</div>
                            <div class="font-bold">H√≠brido</div>
                            <div class="text-xs opacity-75">IA + Chef</div>
                        </div>
                        <div class="toggle-option" data-mode="ai" onclick="setAnalysisMode('ai')">
                            <div class="text-lg mb-1">ü§ñ</div>
                            <div class="font-bold">Solo IA</div>
                            <div class="text-xs opacity-75">Autom√°tico</div>
                        </div>
                        <div class="toggle-option" data-mode="manual" onclick="setAnalysisMode('manual')">
                            <div class="text-lg mb-1">üë®‚Äçüç≥</div>
                            <div class="font-bold">Manual</div>
                            <div class="text-xs opacity-75">Solo Chef</div>
                        </div>
                    </div>

                    <!-- Entrada de Datos -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">
                                üìù Descripci√≥n del Plato
                            </label>
                            <textarea 
                                id="dishDescription" 
                                class="w-full h-24 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all duration-300" 
                                placeholder="Ej: Paella valenciana con gambas, mejillones, pollo, arroz bomba, azafr√°n..."
                            ></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">
                                    üë®‚Äçüç≥ Chef Responsable
                                </label>
                                <input 
                                    type="text" 
                                    id="chefName" 
                                    value="Chef Principal"
                                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all duration-300"
                                >
                            </div>
                            <div class="flex items-end">
                                <button id="analyzeBtn" onclick="analyzeDish()" class="btn-primary w-full flex items-center justify-center">
                                    <span class="mr-2">üîç</span>
                                    <span>Analizar Plato</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Panel de Resultados -->
                    <div id="resultsPanel" class="hidden mt-8">
                        <!-- Informaci√≥n del Plato -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <span class="mr-2">üçΩÔ∏è</span>
                                Plato Identificado
                            </h3>
                            <div id="dishInfo" class="space-y-2">
                                <!-- Se llena din√°micamente -->
                            </div>
                        </div>

                        <!-- Panel de Al√©rgenos -->
                        <div class="hybrid-panel">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <span class="mr-2">‚ö†Ô∏è</span>
                                    Gesti√≥n de Al√©rgenos
                                </h3>
                                <div class="text-sm text-gray-600">
                                    <span id="selectedCount">0</span> de 14 al√©rgenos seleccionados
                                </div>
                            </div>

                            <!-- Sugerencias de IA -->
                            <div id="aiSuggestions" class="ai-suggestion hidden">
                                <h4 class="font-bold text-blue-800 mb-2 flex items-center">
                                    <span class="mr-2">ü§ñ</span>
                                    Sugerencias de IA
                                </h4>
                                <p class="text-sm text-blue-700 mb-3">
                                    La IA ha detectado los siguientes al√©rgenos. Puedes confirmar, a√±adir o quitar seg√∫n tu criterio:
                                </p>
                                <div id="aiDetectedList" class="flex flex-wrap gap-2">
                                    <!-- Se llena din√°micamente -->
                                </div>
                                <div class="mt-3 text-xs text-blue-600">
                                    Confianza del an√°lisis: <span id="aiConfidence" class="font-bold">95%</span>
                                </div>
                            </div>

                            <!-- Grid de Al√©rgenos -->
                            <div class="allergen-grid" id="allergenGrid">
                                <!-- Se llena din√°micamente -->
                            </div>

                            <!-- Resumen -->
                            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-2">üìã Resumen Final</h4>
                                <div id="finalSummary" class="text-sm text-gray-700">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <strong>Al√©rgenos Confirmados:</strong>
                                            <div id="confirmedAllergens" class="mt-1">Ninguno</div>
                                        </div>
                                        <div>
                                            <strong>Estado de Seguridad:</strong>
                                            <div id="safetyStatus" class="mt-1 font-bold text-green-600">‚úÖ Seguro para consumo general</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                            <button id="generateLabelBtn" onclick="generateLabel()" class="btn-primary flex items-center justify-center">
                                <span class="mr-2">‚ú®</span>
                                Generar Etiqueta
                            </button>
                            <button id="printBtn" onclick="printLabel()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 flex items-center justify-center">
                                <span class="mr-2">üñ®Ô∏è</span>
                                Imprimir
                            </button>
                            <button id="saveBtn" onclick="saveDish()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 flex items-center justify-center">
                                <span class="mr-2">üíæ</span>
                                Guardar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panel Lateral -->
            <div class="space-y-8">
                
                <!-- Platos de Hoy -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        <span class="flex items-center">
                            <span class="mr-2">üìã</span>
                            Platos de Hoy
                        </span>
                        <span id="todayCount" class="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded-full">0</span>
                    </h3>
                    <div id="todayDishes" class="space-y-3 max-h-80 overflow-y-auto">
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üçΩÔ∏è</div>
                            <p>No hay platos registrados hoy</p>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">üìä</span>
                        Estad√≠sticas
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">An√°lisis IA</span>
                            <span id="statsAI" class="text-2xl font-bold text-blue-600">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Revisiones Chef</span>
                            <span id="statsManual" class="text-2xl font-bold text-yellow-600">0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Al√©rgenos Detectados</span>
                            <span id="statsAllergens" class="text-2xl font-bold text-red-600">0</span>
                        </div>
                    </div>
                </div>

                <!-- Gu√≠a de Al√©rgenos -->
                <div class="bg-white rounded-2xl shadow-xl p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2">üìö</span>
                        Gu√≠a UE 1169/2011
                    </h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                            <span>üåæ</span><span>Cereales con gluten</span>
                        </div>
                        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                            <span>ü¶ê</span><span>Crust√°ceos</span>
                        </div>
                        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                            <span>ü•ö</span><span>Huevos</span>
                        </div>
                        <div class="flex items-center space-x-2 p-2 bg-gray-50 rounded">
                            <span>üêü</span><span>Pescado</span>
                        </div>
                        <div class="text-center text-xs text-gray-500 mt-2">
                            + 10 al√©rgenos m√°s seg√∫n normativa
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-yellow-500 mx-auto mb-4"></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Analizando...</h3>
                <p id="loadingText" class="text-gray-600">Procesando el plato</p>
            </div>
        </div>
    </div>

    <!-- JavaScript completo -->
    <script>
        // Variables globales
        let currentMode = 'hybrid';
        let currentDish = null;
        let selectedAllergens = new Set();
        let aiSuggestedAllergens = new Set();
        let originalAIAllergens = new Set();
        let stats = { ai: 0, manual: 0, allergens: 0, hybrid: 0 };

        // Lista completa de al√©rgenos UE
        const ALLERGENS = {
            'gluten': { name: 'Cereales con Gluten', icon: 'üåæ', description: 'Trigo, centeno, cebada, avena' },
            'crustaceos': { name: 'Crust√°ceos', icon: 'ü¶ê', description: 'Gambas, langostinos, cangrejos' },
            'huevos': { name: 'Huevos', icon: 'ü•ö', description: 'Huevos y productos derivados' },
            'pescado': { name: 'Pescado', icon: 'üêü', description: 'Pescado y productos derivados' },
            'cacahuetes': { name: 'Cacahuetes', icon: 'ü•ú', description: 'Cacahuetes y productos derivados' },
            'soja': { name: 'Soja', icon: 'üå±', description: 'Soja y productos derivados' },
            'lacteos': { name: 'Leche y L√°cteos', icon: 'ü•õ', description: 'Leche y productos l√°cteos' },
            'frutos_secos': { name: 'Frutos de C√°scara', icon: 'üå∞', description: 'Almendras, nueces, avellanas...' },
            'apio': { name: 'Apio', icon: 'ü•¨', description: 'Apio y productos derivados' },
            'mostaza': { name: 'Mostaza', icon: 'üü°', description: 'Mostaza y productos derivados' },
            'sesamo': { name: 'Granos de S√©samo', icon: 'ü´ò', description: 'S√©samo y productos derivados' },
            'sulfitos': { name: 'Sulfitos', icon: 'üç∑', description: 'Vino, conservas, frutos secos' },
            'altramuces': { name: 'Altramuces', icon: 'ü´ò', description: 'Altramuces y productos derivados' },
            'moluscos': { name: 'Moluscos', icon: 'üêö', description: 'Mejillones, almejas, caracoles...' }
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Inicializando Sistema de Al√©rgenos v2.0');
            initializeApp();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        function initializeApp() {
            setupEventListeners();
            renderAllergenGrid();
            loadTodaysDishes();
            updateStats();
            setAnalysisMode('hybrid');
            console.log('‚úÖ Sistema inicializado correctamente');
        }

        function setupEventListeners() {
            // Event listeners principales
            const analyzeBtn = document.getElementById('analyzeBtn');
            const generateLabelBtn = document.getElementById('generateLabelBtn');
            const printBtn = document.getElementById('printBtn');
            const saveBtn = document.getElementById('saveBtn');
            
            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', analyzeDish);
                console.log('‚úÖ Event listener a√±adido a analyzeBtn');
            }
            
            if (generateLabelBtn) {
                generateLabelBtn.addEventListener('click', generateLabel);
                console.log('‚úÖ Event listener a√±adido a generateLabelBtn');
            }
            
            if (printBtn) {
                printBtn.addEventListener('click', printLabel);
                console.log('‚úÖ Event listener a√±adido a printBtn');
            }
            
            if (saveBtn) {
                saveBtn.addEventListener('click', saveDish);
                console.log('‚úÖ Event listener a√±adido a saveBtn');
            }
            
            // Enter key para analizar
            const dishInput = document.getElementById('dishDescription');
            if (dishInput) {
                dishInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && e.ctrlKey) {
                        e.preventDefault();
                        analyzeDish();
                    }
                });
            }
            
            console.log('üëÇ Event listeners configurados');
        }

        function setAnalysisMode(mode) {
            currentMode = mode;
            console.log(`üéØ Modo de an√°lisis cambiado a: ${mode}`);
            
            // Actualizar UI del selector
            document.querySelectorAll('.toggle-option').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Limpiar selecciones anteriores si cambia el modo
            if (currentDish) {
                selectedAllergens.clear();
                aiSuggestedAllergens.clear();
                renderAllergenGrid();
                updateSummary();
            }
            
            updatePlaceholderByMode(mode);
        }

        function updatePlaceholderByMode(mode) {
            const dishInput = document.getElementById('dishDescription');
            if (!dishInput) return;
            
            const placeholders = {
                'ai': 'Describe el plato y la IA detectar√° autom√°ticamente todos los al√©rgenos...',
                'manual': 'Describe el plato y selecciona manualmente todos los al√©rgenos...',
                'hybrid': 'Describe el plato: la IA detectar√° al√©rgenos y t√∫ podr√°s revisar y modificar...'
            };
            
            dishInput.placeholder = placeholders[mode] || placeholders.hybrid;
        }

        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES');
            const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = `${dateStr} - ${timeStr}`;
            }
        }

        async function analyzeDish() {
            const description = document.getElementById('dishDescription').value.trim();
            const chef = document.getElementById('chefName').value.trim() || 'Chef Principal';

            if (!description) {
                showError('Por favor, describe el plato antes de analizar');
                return;
            }

            console.log(`üîç Iniciando an√°lisis en modo: ${currentMode}`);
            console.log(`üìù Plato: ${description}`);
            
            showLoading('Analizando plato...');
            updateLoadingMessage(currentMode);

            try {
                // Llamada al endpoint h√≠brido
                const response = await fetch('/api/analyze-dish-hybrid', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        chef_name: chef,
                        analysis_mode: currentMode
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error del servidor: ${response.status}`);
                }

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Error en el an√°lisis');
                }

                console.log(`‚úÖ An√°lisis completado:`, data);
                
                // Procesar resultados
                currentDish = data.dish;
                
                // Configurar al√©rgenos seg√∫n el modo
                if (currentMode === 'manual') {
                    // Modo manual: no sugerencias de IA
                    aiSuggestedAllergens.clear();
                    selectedAllergens.clear();
                } else {
                    // Modo AI o h√≠brido: usar sugerencias de IA
                    const detectedAllergens = data.analysis.allergens || [];
                    aiSuggestedAllergens = new Set(detectedAllergens);
                    originalAIAllergens = new Set(detectedAllergens);
                    
                    if (currentMode === 'ai') {
                        // Modo IA: aceptar autom√°ticamente sugerencias
                        selectedAllergens = new Set(detectedAllergens);
                    } else {
                        // Modo h√≠brido: empezar con sugerencias de IA
                        selectedAllergens = new Set(detectedAllergens);
                    }
                }

                displayResults(data);
                updateStats();

            } catch (error) {
                console.error('‚ùå Error en an√°lisis:', error);
                showError(`Error analizando el plato: ${error.message}`);
            } finally {
                hideLoading();
            }
        }

        function updateLoadingMessage(mode) {
            const messages = {
                'ai': 'La IA est√° analizando autom√°ticamente...',
                'manual': 'Preparando interfaz manual...',
                'hybrid': 'IA analizando + preparando revisi√≥n manual...'
            };
            
            const loadingText = document.getElementById('loadingText');
            if (loadingText) {
                loadingText.textContent = messages[mode] || messages.hybrid;
            }
        }

        function displayResults(data) {
            console.log('üìã Mostrando resultados del an√°lisis');
            
            // Mostrar panel de resultados
            const resultsPanel = document.getElementById('resultsPanel');
            if (resultsPanel) {
                resultsPanel.classList.remove('hidden');
                resultsPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }

            // Informaci√≥n del plato
            displayDishInfo(data.dish);
            
            // Mostrar sugerencias de IA si aplica
            displayAISuggestions(data);
            
            // Renderizar grid de al√©rgenos
            renderAllergenGrid();
            
            // Actualizar resumen
            updateSummary();
            
            console.log('‚úÖ Resultados mostrados correctamente');
        }

        function displayDishInfo(dish) {
            const dishInfo = document.getElementById('dishInfo');
            if (!dishInfo) return;
            
            const analysisMode = dish.analysis_mode || 'hybrid';
            const modeText = {
                'ai': 'ü§ñ Solo IA',
                'manual': 'üë®‚Äçüç≥ Solo Manual',
                'hybrid': 'ü§ñ‚ûïüë®‚Äçüç≥ H√≠brido'
            }[analysisMode] || 'ü§ñ‚ûïüë®‚Äçüç≥ H√≠brido';

            dishInfo.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h4 class="font-bold text-lg text-gray-800 mb-1">${dish.name}</h4>
                        <p class="text-gray-600 mb-3">${dish.description}</p>
                        <div class="flex flex-wrap items-center gap-4 text-sm text-gray-500">
                            <span class="flex items-center">
                                <span class="mr-1">üë®‚Äçüç≥</span>
                                <span>${dish.chef}</span>
                            </span>
                            <span class="flex items-center">
                                <span class="mr-1">üìÖ</span>
                                <span>${dish.date}</span>
                            </span>
                            <span class="flex items-center">
                                <span class="mr-1">üïí</span>
                                <span>${new Date(dish.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
                            </span>
                            <span class="flex items-center">
                                <span class="mr-1">‚öôÔ∏è</span>
                                <span>${modeText}</span>
                            </span>
                        </div>
                    </div>
                    <div class="text-4xl ml-4">üçΩÔ∏è</div>
                </div>
            `;
        }

        function displayAISuggestions(data) {
            const aiSuggestions = document.getElementById('aiSuggestions');
            if (!aiSuggestions) return;
            
            const analysis = data.analysis;
            const hasAIDetections = analysis.allergens && analysis.allergens.length > 0;
            
            if (currentMode === 'hybrid' && hasAIDetections) {
                aiSuggestions.classList.remove('hidden');
                
                const confidence = analysis.confidence || {};
                const avgConfidence = Object.keys(confidence).length > 0 
                    ? Object.values(confidence).reduce((a, b) => a + b, 0) / Object.keys(confidence).length 
                    : 0;
                
                const aiList = document.getElementById('aiDetectedList');
                if (aiList) {
                    aiList.innerHTML = analysis.allergens.map(code => {
                        const allergen = ALLERGENS[code];
                        if (!allergen) return '';
                        const conf = confidence[code] || 0;
                        return `
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800 border border-blue-200 hover:bg-blue-200 transition-colors cursor-pointer"
                                  onclick="toggleAllergen('${code}')">
                                ${allergen.icon} ${allergen.name}
                                <span class="ml-1 text-xs">(${Math.round(conf * 100)}%)</span>
                            </span>
                        `;
                    }).join('');
                }
                
                const aiConfidence = document.getElementById('aiConfidence');
                if (aiConfidence) {
                    aiConfidence.textContent = Math.round(avgConfidence * 100) + '%';
                }
            } else {
                aiSuggestions.classList.add('hidden');
            }
        }

        function renderAllergenGrid() {
            const grid = document.getElementById('allergenGrid');
            if (!grid) return;
            
            console.log('üé® Renderizando grid de al√©rgenos');
            
            grid.innerHTML = Object.entries(ALLERGENS).map(([code, allergen]) => {
                const isSelected = selectedAllergens.has(code);
                const isAISuggested = aiSuggestedAllergens.has(code);
                const wasOriginallyAI = originalAIAllergens.has(code);
                
                let cardClass = 'allergen-card';
                let statusClass = '';
                let statusIcon = '';
                
                // Determinar estado visual
                if (isSelected && wasOriginallyAI) {
                    if (currentMode === 'hybrid') {
                        cardClass += ' ai-detected selected';
                        statusClass = 'status-hybrid';
                        statusIcon = 'ü§ñ‚úì';
                    } else {
                        cardClass += ' selected';
                        statusClass = 'status-ai';
                        statusIcon = 'ü§ñ';
                    }
                } else if (isSelected && !wasOriginallyAI) {
                    cardClass += ' selected';
                    statusClass = 'status-manual';
                    statusIcon = 'üë®‚Äçüç≥';
                } else if (isAISuggested && !isSelected) {
                    cardClass += ' ai-detected';
                    statusClass = 'status-ai';
                    statusIcon = 'ü§ñ‚ùå';
                }

                return `
                    <div class="${cardClass}" onclick="toggleAllergen('${code}')" title="Click para ${isSelected ? 'deseleccionar' : 'seleccionar'}">
                        <div class="allergen-header">
                            <div class="flex items-center flex-1">
                                <span class="allergen-icon">${allergen.icon}</span>
                                <div class="flex-1">
                                    <div class="allergen-name">${allergen.name}</div>
                                    <div class="text-xs text-gray-500 mt-1">${allergen.description}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${isSelected ? '<div class="absolute bottom-2 right-2 text-red-600 font-bold text-lg">‚úì</div>' : ''}
                        
                        ${currentMode === 'hybrid' && wasOriginallyAI && !isSelected ? 
                            '<div class="absolute top-2 left-2 text-blue-600 text-xs bg-blue-100 px-1 rounded">IA</div>' : ''}
                    </div>
                `;
            }).join('');
            
            console.log(`‚úÖ Grid renderizado: ${selectedAllergens.size} al√©rgenos seleccionados`);
        }

        function toggleAllergen(code) {
            console.log(`üîÑ Toggle al√©rgeno: ${code} (${ALLERGENS[code].name})`);
            
            // En modo AI puro, no permitir cambios manuales
            if (currentMode === 'ai') {
                showWarning('En modo IA autom√°tico no se pueden hacer cambios manuales. Cambia a modo H√≠brido para revisar.');
                return;
            }
            
            const wasSelected = selectedAllergens.has(code);
            
            if (wasSelected) {
                selectedAllergens.delete(code);
                console.log(`‚ûñ Al√©rgeno ${code} removido`);
                
                // Si era originalmente detectado por IA, mostrar advertencia
                if (originalAIAllergens.has(code)) {
                    showWarning(`‚ö†Ô∏è Has removido "${ALLERGENS[code].name}" que fue detectado por IA. Aseg√∫rate de que es correcto.`);
                }
            } else {
                selectedAllergens.add(code);
                console.log(`‚ûï Al√©rgeno ${code} a√±adido`);
                
                // Si no fue detectado por IA, mostrar confirmaci√≥n
                if (!originalAIAllergens.has(code)) {
                    showInfo(`‚úÖ Has a√±adido "${ALLERGENS[code].name}" manualmente.`);
                }
            }
            
            // Actualizar estad√≠sticas
            if (!wasSelected) {
                stats.manual++;
            }
            
            renderAllergenGrid();
            updateSummary();
            updateStats();
        }

        function updateSummary() {
            const count = selectedAllergens.size;
            
            // Actualizar contador
            const selectedCount = document.getElementById('selectedCount');
            if (selectedCount) {
                selectedCount.textContent = count;
            }

            // Actualizar lista de al√©rgenos confirmados
            const confirmedList = document.getElementById('confirmedAllergens');
            const safetyStatus = document.getElementById('safetyStatus');
            
            if (!confirmedList || !safetyStatus) return;

            if (count === 0) {
                confirmedList.innerHTML = '<span class="text-green-600 font-semibold">‚úÖ Ninguno detectado</span>';
                safetyStatus.innerHTML = '<span class="text-green-600">‚úÖ Seguro para consumo general</span>';
            } else {
                const allergenItems = Array.from(selectedAllergens)
                    .map(code => {
                        const allergen = ALLERGENS[code];
                        if (!allergen) return '';
                        const wasAI = originalAIAllergens.has(code);
                        const source = wasAI ? 'ü§ñ' : 'üë®‚Äçüç≥';
                        return `
                            <div class="flex items-center justify-between p-2 bg-red-50 rounded-lg border border-red-200 mb-2">
                                <span class="flex items-center">
                                    ${allergen.icon} ${allergen.name}
                                </span>
                                <span class="text-xs text-red-600" title="${wasAI ? 'Detectado por IA' : 'A√±adido manualmente'}">${source}</span>
                            </div>
                        `;
                    })
                    .join('');
                    
                confirmedList.innerHTML = allergenItems;
                safetyStatus.innerHTML = `<span class="text-red-600 font-bold">‚ö†Ô∏è Contiene ${count} al√©rgeno${count > 1 ? 's' : ''}</span>`;
            }

            // Actualizar estad√≠sticas globales
            stats.allergens = count;
            updateStats();
        }

        function updateStats() {
            const elements = {
                ai: document.getElementById('statsAI'),
                manual: document.getElementById('statsManual'), 
                allergens: document.getElementById('statsAllergens')
            };
            
            if (elements.ai) elements.ai.textContent = stats.ai;
            if (elements.manual) elements.manual.textContent = stats.manual;
            if (elements.allergens) elements.allergens.textContent = stats.allergens;
        }

        async function generateLabel() {
            if (!currentDish) {
                showError('No hay plato para generar etiqueta');
                return;
            }

            console.log('‚ú® Generando etiqueta...');
            showLoading('Generando etiqueta...');

            try {
                // Actualizar al√©rgenos finales del plato antes de generar
                currentDish.final_allergens = Array.from(selectedAllergens);
                
                const response = await fetch(`/api/generate-beautiful-single/${currentDish.id}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                // Abrir etiqueta en nueva ventana
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Abrir en nueva pesta√±a
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    newWindow.focus();
                    showSuccessMessage('üìÑ Etiqueta abierta en nueva pesta√±a');
                } else {
                    // Fallback: descargar
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `etiqueta_${dishId}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showSuccessMessage('üìÑ Etiqueta descargada');
                }
                
                window.URL.revokeObjectURL(url);

            } catch (error) {
                console.error('‚ùå Error descargando etiqueta:', error);
                showError('Error generando etiqueta');
            } finally {
                hideLoading();
            }
        }

        async function printDishLabel(dishId) {
            try {
                showLoading('Preparando impresi√≥n...');
                
                const response = await fetch(`/api/print-directly/${dishId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showSuccessMessage('üñ®Ô∏è ' + result.message);
                } else {
                    throw new Error(result.error || 'Error de impresi√≥n');
                }
            } catch (error) {
                console.error('‚ùå Error preparando impresi√≥n:', error);
                showError('Error preparando impresi√≥n');
            } finally {
                hideLoading();
            }
        }

        // Funciones de utilidad
        function setsEqual(set1, set2) {
            if (set1.size !== set2.size) return false;
            for (let item of set1) {
                if (!set2.has(item)) return false;
            }
            return true;
        }

        function showLoading(message) {
            const modal = document.getElementById('loadingModal');
            const text = document.getElementById('loadingText');
            
            if (modal) modal.classList.remove('hidden');
            if (text) text.textContent = message || 'Procesando...';
        }

        function hideLoading() {
            const modal = document.getElementById('loadingModal');
            if (modal) modal.classList.add('hidden');
        }

        function showError(message) {
            showToast(message, 'error');
            console.error('üö´ Error:', message);
        }

        function showWarning(message) {
            showToast(message, 'warning');
            console.warn('‚ö†Ô∏è Advertencia:', message);
        }

        function showInfo(message) {
            showToast(message, 'info');
            console.info('‚ÑπÔ∏è Info:', message);
        }

        function showSuccessMessage(message) {
            showToast(message, 'success');
            console.log('‚úÖ √âxito:', message);
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 max-w-sm`;
            toast.textContent = message;
            
            document.body.appendChild(toast);

            // Animar entrada
            setTimeout(() => {
                toast.classList.add('translate-x-0');
            }, 100);

            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 4000);
        }

        // Exponer funciones globalmente
        window.setAnalysisMode = setAnalysisMode;
        window.downloadDishLabel = downloadDishLabel;
        window.printDishLabel = printDishLabel;
        window.toggleAllergen = toggleAllergen;
        window.analyzeDish = analyzeDish;
        window.generateLabel = generateLabel;
        window.printLabel = printLabel;
        window.saveDish = saveDish;

        // Debug y testing
        window.debugSystem = function() {
            console.log('üêõ DEBUG SISTEMA DE AL√âRGENOS');
            console.log('================================');
            console.log('currentMode:', currentMode);
            console.log('currentDish:', currentDish);
            console.log('selectedAllergens:', Array.from(selectedAllergens));
            console.log('aiSuggestedAllergens:', Array.from(aiSuggestedAllergens));
            console.log('originalAIAllergens:', Array.from(originalAIAllergens));
            console.log('stats:', stats);
            console.log('ALLERGENS:', Object.keys(ALLERGENS));
            
            // Test de conectividad
            console.log('\nüîå TEST DE CONECTIVIDAD:');
            fetch('/api/system-status')
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ Sistema conectado:', data);
                })
                .catch(error => {
                    console.error('‚ùå Error de conectividad:', error);
                });
        };

        // Funci√≥n para test r√°pido
        window.testAnalysis = function(description = 'Paella con gambas y mejillones') {
            console.log('üß™ TEST R√ÅPIDO DE AN√ÅLISIS');
            document.getElementById('dishDescription').value = description;
            analyzeDish();
        };

        console.log('üéâ Sistema de Al√©rgenos v2.0 cargado correctamente');
        console.log('üìã Funciones disponibles:');
        console.log('  - debugSystem() - Debug completo del sistema');
        console.log('  - testAnalysis() - Test r√°pido de an√°lisis');
        console.log('  - setAnalysisMode(mode) - Cambiar modo de an√°lisis');

        // Auto-test de conectividad al cargar
        setTimeout(() => {
            fetch('/api/system-status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('‚úÖ Conectividad confirmada con el servidor');
                        console.log(`üìä Estado: ${data.status} | OpenAI: ${data.openai_available ? 'Disponible' : 'No disponible'}`);
                    }
                })
                .catch(error => {
                    console.warn('‚ö†Ô∏è No se pudo conectar con el servidor:', error.message);
                });
        }, 1000);
    </script>
</body>
</html> '_blank');
                if (newWindow) {
                    newWindow.focus();
                    showSuccessMessage('‚ú® Etiqueta abierta en nueva pesta√±a');
                } else {
                    // Fallback: descargar archivo
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `etiqueta_${currentDish.name.replace(/\s+/g, '_')}.html`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    showSuccessMessage('‚ú® Etiqueta descargada correctamente');
                }
                
                window.URL.revokeObjectURL(url);

                stats.ai++; // Incrementar contador
                updateStats();

            } catch (error) {
                console.error('‚ùå Error generando etiqueta:', error);
                showError('Error generando etiqueta: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function printLabel() {
            if (!currentDish) {
                showError('No hay plato para imprimir');
                return;
            }

            console.log('üñ®Ô∏è Preparando impresi√≥n...');
            showLoading('Preparando impresi√≥n...');

            try {
                const response = await fetch(`/api/print-directly/${currentDish.id}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Error en preparaci√≥n de impresi√≥n');
                }

                showSuccessMessage('üñ®Ô∏è ' + data.message);

            } catch (error) {
                console.error('‚ùå Error preparando impresi√≥n:', error);
                showError('Error preparando impresi√≥n: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        async function saveDish() {
            if (!currentDish) {
                showError('No hay plato para guardar');
                return;
            }

            console.log('üíæ Guardando plato...');
            showLoading('Guardando plato en el sistema...');

            try {
                // Preparar datos para guardar
                const dishData = {
                    dish_id: currentDish.id,
                    manual_allergens: Array.from(selectedAllergens),
                    chef_notes: `An√°lisis en modo ${currentMode}. Al√©rgenos confirmados por chef.`,
                    final_analysis_mode: currentMode,
                    ai_suggestions: Array.from(originalAIAllergens),
                    manual_overrides: !setsEqual(selectedAllergens, originalAIAllergens)
                };

                const response = await fetch('/api/save-manual-allergens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dishData)
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || 'Error guardando plato');
                }

                showSuccessMessage('üíæ Plato guardado correctamente');
                
                // Actualizar estad√≠sticas
                stats.hybrid++;
                updateStats();
                
                // Recargar lista de platos del d√≠a
                loadTodaysDishes();
                
                // Preguntar si quiere crear otro plato
                setTimeout(() => {
                    if (confirm('¬øQuieres crear otro plato?')) {
                        clearForm();
                    }
                }, 1500);

            } catch (error) {
                console.error('‚ùå Error guardando plato:', error);
                showError('Error guardando plato: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function clearForm() {
            console.log('üßπ Limpiando formulario');
            
            const dishDescription = document.getElementById('dishDescription');
            if (dishDescription) dishDescription.value = '';
            
            const resultsPanel = document.getElementById('resultsPanel');
            if (resultsPanel) resultsPanel.classList.add('hidden');
            
            currentDish = null;
            selectedAllergens.clear();
            aiSuggestedAllergens.clear();
            originalAIAllergens.clear();
            
            // Scroll al inicio
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        async function loadTodaysDishes() {
            console.log('üìã Cargando platos de hoy...');
            
            try {
                const response = await fetch('/api/dishes/today');
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const dishes = await response.json();
                
                const container = document.getElementById('todayDishes');
                const counter = document.getElementById('todayCount');
                
                if (!container) return;
                
                if (counter) counter.textContent = dishes.length;

                if (dishes.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <div class="text-4xl mb-2">üçΩÔ∏è</div>
                            <p>No hay platos registrados hoy</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = dishes.map(dish => {
                    const allergens = dish.final_allergens || dish.allergens || [];
                    const modeIcon = {
                        'ai': 'ü§ñ',
                        'manual': 'üë®‚Äçüç≥',
                        'hybrid': 'ü§ñüë®‚Äçüç≥'
                    }[dish.analysis_mode] || 'ü§ñüë®‚Äçüç≥';
                    
                    const modeClass = {
                        'ai': 'bg-blue-100 text-blue-800',
                        'manual': 'bg-yellow-100 text-yellow-800', 
                        'hybrid': 'bg-purple-100 text-purple-800'
                    }[dish.analysis_mode] || 'bg-purple-100 text-purple-800';

                    return `
                        <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors border-l-4 ${
                            allergens.length > 0 ? 'border-red-400' : 'border-green-400'
                        }">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-semibold text-gray-800">${dish.name}</h4>
                                <span class="text-xs px-2 py-1 rounded-full ${modeClass}">
                                    ${modeIcon}
                                </span>
                            </div>
                            
                            <p class="text-sm text-gray-600 mb-2 line-clamp-2">${dish.description}</p>
                            
                            <div class="flex items-center justify-between text-sm text-gray-500 mb-2">
                                <span class="flex items-center">
                                    <span class="mr-1">üë®‚Äçüç≥</span>
                                    <span>${dish.chef}</span>
                                </span>
                                <span class="flex items-center">
                                    <span class="mr-1">üïí</span>
                                    <span>${new Date(dish.timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })}</span>
                                </span>
                            </div>
                            
                            ${allergens.length > 0 ? `
                                <div class="flex flex-wrap gap-1 mt-2">
                                    ${allergens.slice(0, 3).map(code => `
                                        <span class="text-xs px-2 py-1 bg-red-100 text-red-800 rounded-full">
                                            ${ALLERGENS[code]?.icon || '‚ö†Ô∏è'} ${ALLERGENS[code]?.name || code}
                                        </span>
                                    `).join('')}
                                    ${allergens.length > 3 ? `
                                        <span class="text-xs px-2 py-1 bg-gray-100 text-gray-600 rounded-full">
                                            +${allergens.length - 3} m√°s
                                        </span>
                                    ` : ''}
                                </div>
                            ` : `
                                <div class="text-xs text-green-600 font-medium mt-2">‚úÖ Sin al√©rgenos</div>
                            `}
                            
                            <div class="mt-3 flex gap-2">
                                <button onclick="downloadDishLabel(${dish.id})" 
                                        class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded transition-colors">
                                    üìÑ Etiqueta
                                </button>
                                <button onclick="printDishLabel(${dish.id})" 
                                        class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded transition-colors">
                                    üñ®Ô∏è Imprimir
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log(`‚úÖ ${dishes.length} platos cargados`);

            } catch (error) {
                console.error('‚ùå Error cargando platos de hoy:', error);
                showError('Error cargando platos del d√≠a');
            }
        }

        async function downloadDishLabel(dishId) {
            try {
                showLoading('Generando etiqueta...');
                
                const response = await fetch(`/api/generate-beautiful-single/${dishId}`, {
                    method: 'POST'
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Abrir en nueva pesta√±a
                const newWindow = window.open(url,
