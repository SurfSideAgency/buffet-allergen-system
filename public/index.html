<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Al√©rgenos - Simple</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --color-primary: #D4AF37;
            --color-primary-dark: #B8860B;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
            min-height: 100vh;
        }

        .main-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .gradient-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
        }

        .analyze-btn {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            transition: all 0.3s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(212, 175, 55, 0.4);
        }

        .allergen-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            border-radius: 12px;
            margin: 0.5rem;
        }

        .dish-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            border-left: 4px solid var(--color-primary);
            transition: all 0.3s ease;
        }

        .dish-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
        }

        .loading.active {
            display: flex;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="p-4">
    
    <!-- Header -->
    <div class="main-card mb-6">
        <div class="gradient-header text-white p-6 rounded-t-3xl">
            <div class="flex items-center justify-center gap-4">
                <div class="text-4xl">üçΩÔ∏è</div>
                <div class="text-center">
                    <h1 class="text-3xl font-bold">Sistema de Al√©rgenos</h1>
                    <p class="text-sm opacity-90">Detecci√≥n autom√°tica inteligente</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenido Principal -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Panel de Entrada -->
        <div class="lg:col-span-2">
            <div class="main-card p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                    <span>üìù</span>
                    Describe el Plato
                </h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            ü•ò Plato e Ingredientes
                        </label>
                        <textarea 
                            id="dishInput"
                            rows="4"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-500 focus:ring-2 focus:ring-yellow-200 transition-all resize-none"
                            placeholder="Ejemplo: Paella valenciana con arroz, gambas, mejillones, pollo, azafr√°n y vino blanco"
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-2">
                            üí° Describe el plato y sus ingredientes principales
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                üë®‚Äçüç≥ Chef Responsable
                            </label>
                            <input 
                                type="text"
                                id="chefInput"
                                value="Chef Principal"
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-yellow-500 transition-all"
                            >
                        </div>
                        <div class="flex items-end">
                            <button 
                                onclick="analyzeDish()"
                                class="analyze-btn w-full text-white font-bold py-3 px-6 rounded-xl">
                                üîç Analizar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading -->
                <div class="loading active items-center justify-center gap-3 mt-6 p-4 bg-blue-50 rounded-xl" id="loading">
                    <div class="spinner w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full"></div>
                    <span class="text-blue-700 font-medium">Analizando...</span>
                </div>

                <!-- Resultados -->
                <div id="results" class="hidden mt-8">
                    <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-500 rounded-xl p-6 mb-6">
                        <h3 class="text-xl font-bold text-green-800 mb-2 flex items-center gap-2">
                            <span>‚úÖ</span>
                            An√°lisis Completado
                        </h3>
                        <div id="dishName" class="text-2xl font-bold text-gray-800 mb-2"></div>
                        <div id="dishMeta" class="text-sm text-gray-600"></div>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-lg font-bold text-gray-800 mb-4">
                            ‚ö†Ô∏è Al√©rgenos Detectados
                        </h4>
                        <div id="allergensList"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button 
                            onclick="generateLabel()"
                            class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-bold py-4 px-6 rounded-xl hover:shadow-lg transition-all">
                            ‚ú® Ver Etiqueta
                        </button>
                        <button 
                            onclick="reset()"
                            class="bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-4 px-6 rounded-xl hover:shadow-lg transition-all">
                            üîÑ Nuevo An√°lisis
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            
            <!-- Platos de Hoy -->
            <div class="main-card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center justify-between">
                    <span class="flex items-center gap-2">
                        <span>üìã</span>
                        Platos de Hoy
                    </span>
                    <span id="dishCount" class="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full">0</span>
                </h3>
                <div id="dishesList" class="space-y-3 max-h-96 overflow-y-auto">
                    <div class="text-center py-8 text-gray-400">
                        <div class="text-4xl mb-2">üçΩÔ∏è</div>
                        <p class="text-sm">Sin platos registrados</p>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div class="main-card p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <span>‚ÑπÔ∏è</span>
                    Informaci√≥n
                </h3>
                <div class="space-y-3 text-sm text-gray-600">
                    <div class="flex items-start gap-2">
                        <span>‚úÖ</span>
                        <p>Cumple normativa europea</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDish = null;

        // Ocultar loading al inicio
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loading').classList.remove('active');
            loadDishes();
        });

        // Analizar plato
        async function analyzeDish() {
            const description = document.getElementById('dishInput').value.trim();
            const chef = document.getElementById('chefInput').value.trim();

            if (!description) {
                showToast('‚ö†Ô∏è Por favor describe el plato', 'warning');
                return;
            }

            // Mostrar loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.add('hidden');

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description, chef })
                });

                const data = await response.json();

                if (data.success) {
                    currentDish = data.dish;
                    displayResults(data);
                    loadDishes();
                    showToast('‚úÖ An√°lisis completado', 'success');
                } else {
                    showToast('‚ùå Error: ' + data.error, 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error de conexi√≥n', 'error');
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // Mostrar resultados
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            const allergensDiv = document.getElementById('allergensList');

            // Info del plato
            document.getElementById('dishName').textContent = data.dish.name;
            document.getElementById('dishMeta').innerHTML = `
                <strong>Chef:</strong> ${data.dish.chef} | 
                <strong>Fecha:</strong> ${data.dish.date}
            `;

            // Al√©rgenos
            if (data.allergens.length > 0) {
                allergensDiv.innerHTML = data.allergens.map(allergen => `
                    <div class="allergen-badge">
                        <span class="text-2xl">${allergen.icon}</span>
                        <div>
                            <div class="font-bold text-sm">${allergen.name}</div>
                            <div class="text-xs opacity-75">${allergen.description}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                allergensDiv.innerHTML = `
                    <div class="bg-green-50 border-2 border-green-500 rounded-xl p-6 text-center">
                        <div class="text-4xl mb-2">‚úÖ</div>
                        <div class="text-green-800 font-bold text-lg">Sin Al√©rgenos</div>
                        <p class="text-green-600 text-sm mt-1">Este plato no contiene al√©rgenos detectados</p>
                    </div>
                `;
            }

            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // Generar etiqueta
        async function generateLabel() {
            if (!currentDish) {
                showToast('‚ö†Ô∏è No hay plato para generar etiqueta', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/generate-label', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ dishId: currentDish.id })
                });

                if (response.ok) {
                    const html = await response.text();
                    const newWindow = window.open('', '_blank');
                    newWindow.document.write(html);
                    newWindow.document.close();
                    showToast('‚ú® Etiqueta generada', 'success');
                } else {
                    showToast('‚ùå Error generando etiqueta', 'error');
                }

            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Resetear formulario
        function reset() {
            document.getElementById('dishInput').value = '';
            document.getElementById('results').classList.add('hidden');
            currentDish = null;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Cargar platos del d√≠a
        async function loadDishes() {
            try {
                const response = await fetch('/api/dishes');
                const data = await response.json();

                const dishesList = document.getElementById('dishesList');
                const dishCount = document.getElementById('dishCount');

                dishCount.textContent = data.count;

                if (data.count === 0) {
                    dishesList.innerHTML = `
                        <div class="text-center py-8 text-gray-400">
                            <div class="text-4xl mb-2">üçΩÔ∏è</div>
                            <p class="text-sm">Sin platos registrados</p>
                        </div>
                    `;
                    return;
                }

                dishesList.innerHTML = data.dishes.map(dish => `
                    <div class="dish-card">
                        <div class="font-bold text-gray-800 mb-1">${dish.name}</div>
                        <div class="text-xs text-gray-500 mb-2">
                            üë®‚Äçüç≥ ${dish.chef}
                        </div>
                        ${dish.allergens.length > 0 ? `
                            <div class="text-xs">
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full">
                                    ‚ö†Ô∏è ${dish.allergens.length} al√©rgeno${dish.allergens.length > 1 ? 's' : ''}
                                </span>
                            </div>
                        ` : `
                            <div class="text-xs text-green-600 font-medium">‚úÖ Sin al√©rgenos</div>
                        `}
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error cargando platos:', error);
            }
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-fade-in`;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Enter para enviar
        document.getElementById('dishInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                analyzeDish();
            }
        });
    </script>

    <style>
        @keyframes fade-in {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
            transition: all 0.3s ease;
        }
    </style>

</body>
</html>
                        <span>ü§ñ</span>
                        <p>Detecci√≥n autom√°tica con IA</p>
                    </div>
                    <div class="flex items-start gap-2">
                        <span>‚ö†Ô∏è</span>
                        <p>14 al√©rgenos UE 1169/2011</p>
                    </div>
                    <div class="flex items-start gap-2">
                        <span>üìÑ</span>
                        <p>Etiquetas imprimibles</p>
                    </div>
                    <div class="flex items-start gap-2">
