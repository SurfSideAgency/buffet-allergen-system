// ============================================
// A√ëADIR ESTAS FUNCIONES AL admin.html
// ============================================

// 1. MODIFICAR displayEstablishments para mostrar dispositivos activos

function displayEstablishments(establishments) {
    const tbody = document.getElementById('establishmentsTable');
    
    if (establishments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-400">No hay establecimientos creados</td></tr>';
        return;
    }

    tbody.innerHTML = establishments.map(est => {
        const statusClass = est.status === 'active' ? 'status-active' : 
                            est.isExpired ? 'status-expired' : 'status-suspended';
        
        const statusText = est.status === 'active' && !est.isExpired ? '‚úÖ Activa' : 
                           est.isExpired ? '‚ùå Expirada' : '‚ö†Ô∏è Suspendida';

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-6 py-4">
                    <div class="font-semibold text-gray-900">${est.name}</div>
                    <div class="text-sm text-gray-500">${est.contact_email || '-'}</div>
                </td>
                <td class="px-6 py-4">
                    <code class="text-sm bg-gray-100 px-2 py-1 rounded">${est.license_key}</code>
                </td>
                <td class="px-6 py-4">
                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusClass}">
                        ${statusText}
                    </span>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">
                    ${new Date(est.expires_at).toLocaleDateString('es-ES')}
                </td>
                <td class="px-6 py-4">
                    <span class="${est.daysRemaining < 7 ? 'text-red-600 font-bold' : 'text-gray-700'}">
                        ${est.daysRemaining} d√≠as
                    </span>
                </td>
                <td class="px-6 py-4">
                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-semibold">
                        üì± ${est.activeDevices || 0}/${est.max_devices || 3}
                    </span>
                </td>
                <td class="px-6 py-4">
                    <button onclick="showDevicesModal(${est.id}, '${est.name}')" class="text-blue-600 hover:text-blue-800 font-semibold text-sm mr-3">
                        üì± Dispositivos
                    </button>
                    <button onclick="showExtendModal(${est.id}, '${est.name}', '${est.license_key}')" class="text-purple-600 hover:text-purple-800 font-semibold text-sm mr-3">
                        ‚è∞ Extender
                    </button>
                    <button onclick="toggleStatus(${est.id}, '${est.status}')" class="text-gray-600 hover:text-gray-800 font-semibold text-sm">
                        ${est.status === 'active' ? '‚è∏Ô∏è Suspender' : '‚ñ∂Ô∏è Activar'}
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// 2. A√ëADIR columna de dispositivos en la tabla HTML
// MODIFICAR el <thead> de la tabla en el HTML:
/*
<thead class="bg-gray-50">
    <tr>
        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Establecimiento</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">C√≥digo Licencia</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Estado</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Expira</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">D√≠as Restantes</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">üì± Dispositivos</th>
        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Acciones</th>
    </tr>
</thead>
*/

// 3. MODAL para ver y gestionar dispositivos

async function showDevicesModal(establishmentId, establishmentName) {
    try {
        const response = await fetch(`/api/admin/establishments/${establishmentId}/devices`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (!data.success) {
            alert('Error: ' + data.error);
            return;
        }

        const devices = data.devices || [];
        
        const modal = document.createElement('div');
        modal.id = 'devicesModal';
        modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4';
        modal.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">üì± Dispositivos Activos</h2>
                        <p class="text-sm text-gray-600">${establishmentName}</p>
                    </div>
                    <button onclick="closeDevicesModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
                </div>

                ${devices.length === 0 ? `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üì±</div>
                        <p class="text-gray-500">No hay dispositivos activos</p>
                    </div>
                ` : `
                    <div class="space-y-3">
                        ${devices.map(device => `
                            <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-blue-300 transition-all">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-2 mb-2">
                                            <span class="text-2xl">üì±</span>
                                            <code class="text-sm bg-gray-100 px-2 py-1 rounded font-mono">${device.device_fingerprint}</code>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                            <div>
                                                <strong>IP:</strong> ${device.ip_address || 'N/A'}
                                            </div>
                                            <div>
                                                <strong>√öltima actividad:</strong> ${new Date(device.last_activity).toLocaleString('es-ES')}
                                            </div>
                                            <div class="col-span-2">
                                                <strong>Primera conexi√≥n:</strong> ${new Date(device.first_seen).toLocaleString('es-ES')}
                                            </div>
                                        </div>
                                    </div>
                                    <button 
                                        onclick="deactivateDevice(${establishmentId}, '${device.device_fingerprint}', '${establishmentName}')"
                                        class="ml-4 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition-all">
                                        üóëÔ∏è Desactivar
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <div class="mt-6 bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-800">
                            <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Los dispositivos inactivos durante m√°s de 30 d√≠as se desactivan autom√°ticamente.
                        </p>
                    </div>
                `}

                <div class="mt-6 flex gap-3">
                    <button onclick="closeDevicesModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition-all">
                        Cerrar
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);

    } catch (error) {
        console.error('Error:', error);
        alert('Error cargando dispositivos');
    }
}

function closeDevicesModal() {
    const modal = document.getElementById('devicesModal');
    if (modal) modal.remove();
}

async function deactivateDevice(establishmentId, deviceFingerprint, establishmentName) {
    if (!confirm(`¬øConfirmas desactivar este dispositivo de "${establishmentName}"?\n\nEl usuario deber√° volver a activar la licencia en ese dispositivo.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/admin/establishments/${establishmentId}/devices/${encodeURIComponent(deviceFingerprint)}/deactivate`, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('‚úÖ Dispositivo desactivado correctamente');
            closeDevicesModal();
            showDevicesModal(establishmentId, establishmentName); // Recargar
        } else {
            alert('‚ùå Error: ' + data.error);
        }

    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n');
    }
}

// 4. MODIFICAR createLicense para incluir l√≠mite de dispositivos

async function createLicense() {
    const name = document.getElementById('newName').value.trim();
    const contact_email = document.getElementById('newEmail').value.trim();
    const contact_phone = document.getElementById('newPhone').value.trim();
    const address = document.getElementById('newAddress').value.trim();
    const durationMonths = document.getElementById('newDuration').value;
    const maxDevices = document.getElementById('newMaxDevices')?.value || 3; // NUEVO

    if (!name || !contact_email) {
        alert('‚ö†Ô∏è Completa los campos obligatorios');
        return;
    }

    try {
        const response = await fetch('/api/admin/establishments', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                name,
                contact_email,
                contact_phone,
                address,
                durationMonths,
                maxDevices: parseInt(maxDevices) // NUEVO
            })
        });

        const data = await response.json();

        if (data.success) {
            alert(`‚úÖ Licencia creada correctamente!\n\nC√≥digo: ${data.establishment.license_key}\nDispositivos permitidos: ${maxDevices}\n\nEnv√≠a este c√≥digo al cliente.`);
            closeCreateModal();
            loadEstablishments();
        } else {
            alert('‚ùå Error: ' + data.error);
        }

    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n');
    }
}

// 5. A√ëADIR campo de dispositivos al modal de crear licencia
// MODIFICAR el HTML del modal "createModal" para incluir:

/*
A√ëADIR ESTE CAMPO DESPU√âS DEL CAMPO "Duraci√≥n":

<div>
    <label class="block text-sm font-semibold text-gray-700 mb-2">L√≠mite de Dispositivos *</label>
    <select id="newMaxDevices" class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:outline-none">
        <option value="1">1 dispositivo (B√°sico)</option>
        <option value="3" selected>3 dispositivos (Est√°ndar)</option>
        <option value="5">5 dispositivos (Profesional)</option>
        <option value="10">10 dispositivos (Empresarial)</option>
        <option value="999">Ilimitado (Premium)</option>
    </select>
    <p class="text-xs text-gray-500 mt-1">N√∫mero m√°ximo de dispositivos que pueden usar esta licencia simult√°neamente</p>
</div>
*/

// 6. FUNCI√ìN para actualizar l√≠mite de dispositivos de una licencia existente

async function updateMaxDevices(establishmentId, establishmentName) {
    const newLimit = prompt(`¬øCu√°ntos dispositivos permitir para "${establishmentName}"?\n\nActual l√≠mite visible en la tabla.`);
    
    if (!newLimit || isNaN(newLimit)) {
        return;
    }

    try {
        const response = await fetch(`/api/admin/establishments/${establishmentId}/max-devices`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                maxDevices: parseInt(newLimit)
            })
        });

        const data = await response.json();

        if (data.success) {
            alert(`‚úÖ L√≠mite actualizado a ${newLimit} dispositivos`);
            loadEstablishments();
        } else {
            alert('‚ùå Error: ' + data.error);
        }

    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error de conexi√≥n');
    }
}

// 7. ACTUALIZAR updateStats para incluir info de dispositivos

function updateStats(establishments) {
    const total = establishments.length;
    const active = establishments.filter(e => e.status === 'active' && !e.isExpired).length;
    const expiring = establishments.filter(e => e.daysRemaining > 0 && e.daysRemaining <= 7).length;
    const expired = establishments.filter(e => e.isExpired).length;
    
    // NUEVO: Estad√≠sticas de dispositivos
    const totalDevices = establishments.reduce((sum, e) => sum + (e.activeDevices || 0), 0);
    const avgDevices = total > 0 ? (totalDevices / total).toFixed(1) : 0;

    document.getElementById('totalEstablishments').textContent = total;
    document.getElementById('activeEstablishments').textContent = active;
    document.getElementById('expiringEstablishments').textContent = expiring;
    document.getElementById('expiredEstablishments').textContent = expired;
    
    // Si quieres a√±adir una tarjeta nueva de estad√≠sticas de dispositivos:
    // A√±ade esto al HTML despu√©s de las 4 tarjetas existentes:
    /*
    <div class="bg-white rounded-xl shadow-sm p-6">
        <div class="text-3xl mb-2">üì±</div>
        <div class="text-2xl font-bold text-blue-600" id="totalDevices">0</div>
        <div class="text-sm text-gray-600">Dispositivos Activos</div>
    </div>
    */
    
    // Y actualiza aqu√≠:
    const totalDevicesEl = document.getElementById('totalDevices');
    if (totalDevicesEl) {
        totalDevicesEl.textContent = totalDevices;
    }
}

// ============================================
// RESUMEN DE CAMBIOS NECESARIOS EN EL HTML
// ============================================

/*
1. MODIFICAR la tabla para incluir columna "Dispositivos":
   - A√±adir <th> en el <thead>
   - Ya est√° incluido en displayEstablishments()

2. A√ëADIR campo "L√≠mite de Dispositivos" en el modal de crear licencia:
   - Copiar el <div> con <select id="newMaxDevices"> que est√° arriba

3. OPCIONAL: A√±adir tarjeta de estad√≠sticas de dispositivos:
   - Copiar el HTML de la tarjeta comentado arriba

4. Las funciones JavaScript ya est√°n todas aqu√≠, solo copiarlas al final del <script>
*/
