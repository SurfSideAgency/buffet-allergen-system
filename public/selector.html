<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Al√©rgenos - Chef + IA</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .allergen-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1rem;
            background: white;
            position: relative;
        }

        .allergen-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-color: #D4AF37;
        }

        .allergen-card.selected {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            transform: scale(1.02);
        }

        .allergen-card.ai-suggested {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }

        .allergen-card.ai-suggested.selected {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
        }

        .check-icon {
            position: absolute;
            bottom: 8px;
            right: 8px;
            color: #ef4444;
            font-weight: bold;
            font-size: 1.25rem;
        }

        .mode-btn {
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .mode-btn.active {
            background: #D4AF37;
            color: white;
            border-color: #D4AF37;
        }

        .suggestion-tag {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background: #3b82f6;
            color: white;
            border-radius: 50px;
            font-size: 0.875rem;
            margin: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .suggestion-tag:hover {
            background: #1d4ed8;
        }

        .suggestion-tag.accepted {
            background: #10b981;
        }

        .allergen-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .allergen-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    
    <!-- Header -->
    <div class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-gradient-to-br from-yellow-400 to-yellow-600 text-white rounded-full p-3 mr-4">
                        <span class="text-2xl">üçΩÔ∏è</span>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900">Sistema de Al√©rgenos</h1>
                        <p class="text-gray-600">Chef + IA: Selecci√≥n Manual Inteligente</p>
                    </div>
                </div>
                <div class="text-right">
                    <div class="flex items-center space-x-2 text-green-600">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span class="text-sm font-medium">Sistema Activo</span>
                    </div>
                    <div class="text-xs text-gray-500" id="currentDateTime"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Panel Principal -->
        <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">üéØ Registrar Nuevo Plato</h2>

            <!-- Selector de Modo -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <button class="mode-btn active" data-mode="hybrid" onclick="setMode('hybrid')">
                    <div class="text-2xl mb-2">ü§ñüë®‚Äçüç≥</div>
                    <div class="font-bold">H√≠brido</div>
                    <div class="text-xs opacity-75">IA + Chef</div>
                </button>
                <button class="mode-btn" data-mode="ai" onclick="setMode('ai')">
                    <div class="text-2xl mb-2">ü§ñ</div>
                    <div class="font-bold">Solo IA</div>
                    <div class="text-xs opacity-75">Autom√°tico</div>
                </button>
                <button class="mode-btn" data-mode="manual" onclick="setMode('manual')">
                    <div class="text-2xl mb-2">üë®‚Äçüç≥</div>
                    <div class="font-bold">Solo Chef</div>
                    <div class="text-xs opacity-75">Manual 100%</div>
                </button>
            </div>

            <!-- Entrada -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">üìù Descripci√≥n del Plato</label>
                    <textarea 
                        id="dishDescription" 
                        class="w-full h-20 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 transition-all" 
                        placeholder="Ejemplo: Paella valenciana con gambas, mejillones, pollo y azafr√°n..."
                    ></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">üë®‚Äçüç≥ Chef</label>
                        <input 
                            type="text" 
                            id="chefName" 
                            value="Chef Principal"
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-yellow-500 transition-all"
                        >
                    </div>
                    <div class="flex items-end">
                        <button id="analyzeBtn" onclick="analyzeDish()" class="w-full bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-bold py-3 px-6 rounded-lg transition-all">
                            üîç Analizar Plato
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de Resultados -->
        <div id="resultsPanel" class="hidden">
            
            <!-- Info del Plato -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">üçΩÔ∏è Plato Identificado</h3>
                <div id="dishInfo" class="bg-blue-50 rounded-lg p-4"></div>
            </div>

            <!-- Sugerencias IA -->
            <div id="aiSuggestions" class="bg-white rounded-2xl shadow-xl p-6 mb-6 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    ü§ñ Sugerencias de IA
                    <span class="ml-auto text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full" id="aiConfidence">95%</span>
                </h3>
                
                <div class="bg-blue-50 rounded-lg p-4 mb-4">
                    <p class="text-blue-800 font-medium mb-3">
                        La IA detect√≥ estos al√©rgenos. Haz clic para confirmar o rechazar:
                    </p>
                    <div id="suggestionTags" class="mb-4"></div>
                    
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="acceptAllSuggestions()" class="px-4 py-2 bg-green-500 text-white rounded-lg text-sm hover:bg-green-600 transition-all">
                            ‚úÖ Aceptar Todas
                        </button>
                        <button onclick="rejectAllSuggestions()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm hover:bg-red-600 transition-all">
                            ‚ùå Rechazar Todas
                        </button>
                        <button onclick="clearAll()" class="px-4 py-2 bg-gray-500 text-white rounded-lg text-sm hover:bg-gray-600 transition-all">
                            üßπ Limpiar Todo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Selector de Al√©rgenos -->
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-800">‚ö†Ô∏è Seleccionar Al√©rgenos</h3>
                    <div class="text-sm text-gray-600">
                        <span id="selectedCount" class="font-bold text-red-600">0</span> de 14 seleccionados
                    </div>
                </div>

                <!-- Grid de Al√©rgenos -->
                <div class="allergen-grid" id="allergenGrid"></div>

                <!-- Resumen -->
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-gray-800 mb-3">üìã Resumen Final</h4>
                    <div id="finalSummary">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <strong>Al√©rgenos Confirmados:</strong>
                                <div id="confirmedList" class="mt-2">Ninguno</div>
                            </div>
                            <div>
                                <strong>Estado:</strong>
                                <div id="safetyStatus" class="mt-2 font-bold text-green-600">‚úÖ Seguro</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botones Finales -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="generateLabel()" class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-bold py-4 px-6 rounded-lg">
                    ‚ú® Generar Etiqueta
                </button>
                <button onclick="printLabel()" class="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-4 px-6 rounded-lg">
                    üñ®Ô∏è Imprimir
                </button>
                <button onclick="saveDish()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white font-bold py-4 px-6 rounded-lg">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-8 max-w-sm w-full mx-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-yellow-500 mx-auto mb-4"></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Analizando...</h3>
                <p id="loadingText" class="text-gray-600">Procesando</p>
            </div>
        </div>
    </div>

    <script>
        // Variables
        let currentMode = 'hybrid';
        let currentDish = null;
        let selectedAllergens = new Set();
        let aiSuggestions = new Set();

        // Al√©rgenos UE
        const ALLERGENS = {
            'gluten': { name: 'Cereales con Gluten', icon: 'üåæ', description: 'Trigo, centeno, cebada' },
            'crustaceos': { name: 'Crust√°ceos', icon: 'ü¶ê', description: 'Gambas, langostinos' },
            'huevos': { name: 'Huevos', icon: 'ü•ö', description: 'Huevos y derivados' },
            'pescado': { name: 'Pescado', icon: 'üêü', description: 'Pescado y derivados' },
            'cacahuetes': { name: 'Cacahuetes', icon: 'ü•ú', description: 'Cacahuetes y derivados' },
            'soja': { name: 'Soja', icon: 'üå±', description: 'Soja y derivados' },
            'lacteos': { name: 'L√°cteos', icon: 'ü•õ', description: 'Leche y l√°cteos' },
            'frutos_secos': { name: 'Frutos Secos', icon: 'üå∞', description: 'Almendras, nueces' },
            'apio': { name: 'Apio', icon: 'ü•¨', description: 'Apio y derivados' },
            'mostaza': { name: 'Mostaza', icon: 'üü°', description: 'Mostaza y derivados' },
            'sesamo': { name: 'S√©samo', icon: 'ü´ò', description: 'S√©samo y derivados' },
            'sulfitos': { name: 'Sulfitos', icon: 'üç∑', description: 'Vino, conservas' },
            'altramuces': { name: 'Altramuces', icon: 'ü´ò', description: 'Altramuces y derivados' },
            'moluscos': { name: 'Moluscos', icon: 'üêö', description: 'Mejillones, almejas' }
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            renderAllergenGrid();
            updateDateTime();
            setInterval(updateDateTime, 1000);
        });

        function updateDateTime() {
            document.getElementById('currentDateTime').textContent = 
                new Date().toLocaleString('es-ES');
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        async function analyzeDish() {
            const description = document.getElementById('dishDescription').value.trim();
            const chef = document.getElementById('chefName').value.trim();

            if (!description) {
                alert('Por favor, describe el plato');
                return;
            }

            showLoading('Analizando plato...');

            try {
                const response = await fetch('/api/analyze-dish-hybrid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        description: description,
                        chef_name: chef,
                        analysis_mode: currentMode
                    })
                });

                const data = await response.json();

                if (data.success) {
                    currentDish = data.dish;
                    
                    if (currentMode !== 'manual') {
                        aiSuggestions = new Set(data.analysis.allergens || []);
                        selectedAllergens = new Set(data.analysis.allergens || []);
                    } else {
                        aiSuggestions.clear();
                        selectedAllergens.clear();
                    }

                    displayResults(data);
                } else {
                    alert('Error: ' + data.error);
                }
                
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        function displayResults(data) {
            document.getElementById('resultsPanel').classList.remove('hidden');
            
            // Info del plato
            document.getElementById('dishInfo').innerHTML = `
                <h4 class="font-bold text-xl">${currentDish.name}</h4>
                <p class="text-gray-600 mt-1">${currentDish.description}</p>
                <div class="flex items-center space-x-4 text-sm text-gray-500 mt-2">
                    <span>üë®‚Äçüç≥ ${currentDish.chef}</span>
                    <span>üìÖ ${currentDish.date}</span>
                    <span>‚öôÔ∏è ${currentMode}</span>
                </div>
            `;

            // Sugerencias IA
            if (currentMode === 'hybrid' && aiSuggestions.size > 0) {
                document.getElementById('aiSuggestions').classList.remove('hidden');
                displayAISuggestions();
            } else {
                document.getElementById('aiSuggestions').classList.add('hidden');
            }

            renderAllergenGrid();
            updateSummary();
        }

        function displayAISuggestions() {
            const container = document.getElementById('suggestionTags');
            container.innerHTML = Array.from(aiSuggestions).map(code => {
                const allergen = ALLERGENS[code];
                const isSelected = selectedAllergens.has(code);
                return `
                    <span class="suggestion-tag ${isSelected ? 'accepted' : ''}" 
                          onclick="toggleSuggestion('${code}')">
                        ${allergen.icon} ${allergen.name} ${isSelected ? '‚úì' : ''}
                    </span>
                `;
            }).join('');
        }

        function renderAllergenGrid() {
            const grid = document.getElementById('allergenGrid');
            
            grid.innerHTML = Object.entries(ALLERGENS).map(([code, allergen]) => {
                const isSelected = selectedAllergens.has(code);
                const isAISuggested = aiSuggestions.has(code);
                
                let cardClass = 'allergen-card';
                if (isSelected && isAISuggested) {
                    cardClass += ' ai-suggested selected';
                } else if (isSelected) {
                    cardClass += ' selected';
                } else if (isAISuggested) {
                    cardClass += ' ai-suggested';
                }

                return `
                    <div class="${cardClass}" onclick="toggleAllergen('${code}')">
                        <div class="flex items-center mb-2">
                            <span class="text-2xl mr-3">${allergen.icon}</span>
                            <div>
                                <div class="font-bold">${allergen.name}</div>
                                <div class="text-sm text-gray-500">${allergen.description}</div>
                            </div>
                        </div>
                        ${isSelected ? '<div class="check-icon">‚úì</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        function toggleAllergen(code) {
            if (selectedAllergens.has(code)) {
                selectedAllergens.delete(code);
                showToast(`‚ùå Removido: ${ALLERGENS[code].name}`);
            } else {
                selectedAllergens.add(code);
                showToast(`‚úÖ A√±adido: ${ALLERGENS[code].name}`);
            }
            
            renderAllergenGrid();
            updateSummary();
            if (currentMode === 'hybrid') displayAISuggestions();
        }

        function toggleSuggestion(code) {
            toggleAllergen(code);
        }

        function acceptAllSuggestions() {
            aiSuggestions.forEach(code => selectedAllergens.add(code));
            showToast('‚úÖ Todas las sugerencias aceptadas');
            renderAllergenGrid();
            updateSummary();
            displayAISuggestions();
        }

        function rejectAllSuggestions() {
            aiSuggestions.forEach(code => selectedAllergens.delete(code));
            showToast('‚ùå Todas las sugerencias rechazadas');
            renderAllergenGrid();
            updateSummary();
            displayAISuggestions();
        }

        function clearAll() {
            selectedAllergens.clear();
            showToast('üßπ Todo limpiado');
            renderAllergenGrid();
            updateSummary();
            displayAISuggestions();
        }

        function updateSummary() {
            const count = selectedAllergens.size;
            document.getElementById('selectedCount').textContent = count;

            const confirmedList = document.getElementById('confirmedList');
            const safetyStatus = document.getElementById('safetyStatus');

            if (count === 0) {
                confirmedList.innerHTML = '<span class="text-green-600 font-semibold">‚úÖ Ninguno</span>';
                safetyStatus.innerHTML = '<span class="text-green-600">‚úÖ Seguro</span>';
            } else {
                const items = Array.from(selectedAllergens).map(code => {
                    const allergen = ALLERGENS[code];
                    const isAI = aiSuggestions.has(code);
                    return `
                        <div class="flex items-center justify-between p-2 bg-red-50 rounded mb-1">
                            <span>${allergen.icon} ${allergen.name}</span>
                            <span class="text-xs">${isAI ? 'ü§ñ' : 'üë®‚Äçüç≥'}</span>
                        </div>
                    `;
                }).join('');

                confirmedList.innerHTML = items;
                safetyStatus.innerHTML = `<span class="text-red-600">‚ö†Ô∏è ${count} al√©rgeno${count > 1 ? 's' : ''}</span>`;
            }
        }

        async function generateLabel() {
            if (!currentDish) return;
            showLoading('Generando etiqueta...');
            
            try {
                const response = await fetch(`/api/generate-beautiful-single/${currentDish.id}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `etiqueta_${currentDish.name.replace(/\s+/g, '_')}.html`;
                    a.click();
                    showToast('‚ú® Etiqueta descargada');
                }
            } catch (error) {
                showToast('Error generando etiqueta', 'error');
            } finally {
                hideLoading();
            }
        }

        async function printLabel() {
            if (!currentDish) return;
            showLoading('Preparando impresi√≥n...');
            
            try {
                await fetch(`/api/print-directly/${currentDish.id}`, { method: 'POST' });
                showToast('üñ®Ô∏è Enviado a impresora');
            } catch (error) {
                showToast('Error imprimiendo', 'error');
            } finally {
                hideLoading();
            }
        }

        async function saveDish() {
            if (!currentDish) return;
            showLoading('Guardando...');
            
            try {
                await fetch('/api/save-final-dish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dish_id: currentDish.id,
                        final_allergens: Array.from(selectedAllergens),
                        chef_approval: true
                    })
                });
                
                showToast('üíæ Plato guardado');
                setTimeout(() => {
                    if (confirm('¬øAnalizar otro plato?')) {
                        location.reload();
                    }
                }, 2000);
            } catch (error) {
                showToast('Error guardando', 'error');
            } finally {
                hideLoading();
            }
        }

        function showLoading(message) {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }

        function showToast(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };

            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
</body>
</html>
